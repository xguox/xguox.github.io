<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ç»™ Ruby on Rails æé€Ÿ - XguoX - å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="XguoX" /><meta name="description" content="Repost Ruby è¯­è¨€å¸¸ä»¥å…¶çµæ´»æ€§ä¸ºäººæ‰€ç§°é“.æ­£å¦‚ Dick Sites æ‰€è¨€,æ‚¨å¯ä»¥ &amp;ldquo;ä¸ºäº†ç¼–ç¨‹è€Œç¼–ç¨‹&amp;rdquo;.Ruby on Rails æ‰©å±•äº†æ ¸å¿ƒ Ruby è¯­è¨€,ä½†æ­£æ˜¯ Ruby æœ¬èº«ä½¿" /><meta name="keywords" content="Ruby, Golang, Erlang, å‰ç«¯, åç«¯, Android, Elasticsearch, Programmer, Photo, Lens, Camera, Sony, A7r, Fujifilm, Lego" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://xguox.me/ror-performance.html/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3eafe5cf.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ç»™ Ruby on Rails æé€Ÿ" />
<meta property="og:description" content="Repost Ruby è¯­è¨€å¸¸ä»¥å…¶çµæ´»æ€§ä¸ºäººæ‰€ç§°é“.æ­£å¦‚ Dick Sites æ‰€è¨€,æ‚¨å¯ä»¥ &ldquo;ä¸ºäº†ç¼–ç¨‹è€Œç¼–ç¨‹&rdquo;.Ruby on Rails æ‰©å±•äº†æ ¸å¿ƒ Ruby è¯­è¨€,ä½†æ­£æ˜¯ Ruby æœ¬èº«ä½¿" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xguox.me/ror-performance.html/" />
<meta property="article:published_time" content="2011-12-25T16:01:23&#43;08:00"/>
<meta property="article:modified_time" content="2011-12-25T16:01:23&#43;08:00"/>

<meta itemprop="name" content="ç»™ Ruby on Rails æé€Ÿ">
<meta itemprop="description" content="Repost Ruby è¯­è¨€å¸¸ä»¥å…¶çµæ´»æ€§ä¸ºäººæ‰€ç§°é“.æ­£å¦‚ Dick Sites æ‰€è¨€,æ‚¨å¯ä»¥ &ldquo;ä¸ºäº†ç¼–ç¨‹è€Œç¼–ç¨‹&rdquo;.Ruby on Rails æ‰©å±•äº†æ ¸å¿ƒ Ruby è¯­è¨€,ä½†æ­£æ˜¯ Ruby æœ¬èº«ä½¿">


<meta itemprop="datePublished" content="2011-12-25T16:01:23&#43;08:00" />
<meta itemprop="dateModified" content="2011-12-25T16:01:23&#43;08:00" />
<meta itemprop="wordCount" content="5214">



<meta itemprop="keywords" content="Ruby," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ç»™ Ruby on Rails æé€Ÿ"/>
<meta name="twitter:description" content="Repost Ruby è¯­è¨€å¸¸ä»¥å…¶çµæ´»æ€§ä¸ºäººæ‰€ç§°é“.æ­£å¦‚ Dick Sites æ‰€è¨€,æ‚¨å¯ä»¥ &ldquo;ä¸ºäº†ç¼–ç¨‹è€Œç¼–ç¨‹&rdquo;.Ruby on Rails æ‰©å±•äº†æ ¸å¿ƒ Ruby è¯­è¨€,ä½†æ­£æ˜¯ Ruby æœ¬èº«ä½¿"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div class="row">
    <div class="col s12 m4">
      <div class="table cover">
        <div class="cover-card table-cell table-middle">

  <img src="/img/logo.jpeg" alt="" class="avatar">

  <a href="https://xguox.me/" class="author_name">XguoX</a>
  <span class="author_job">å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</span>
  <span class="author_bio mbm"> ğŸ¨ é•¿è‰å­¦ç”»ç”» ... </span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://xguox.me/">home</a>
        <span>/</span>
      </li>

      <li class="nav-item">
        <a href="https://xguox.me/post/">Archive</a>

          <span>/</span>

      </li>

      <li class="nav-item">
        <a href="https://xguox.me/categories/">Categories</a>
      </li>

    </ul>
  </nav>

  <div class="social-links">
    <ul>
        <li><a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a></li>
        <li><a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a></li>
        <li><a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a></li>
    <li>
      <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
    </li>
    </ul>
  </div>

  <section id="js-search" class="p-3 p-lg-5 d-flex flex-column">
    <div class="my-auto" >
      <form action="https://xguox.me/search">
        <input id="search-query" name="s" placeholder="~$ enter to search"/>
      </form>
    </div>
  </section>
</div>
      </div>
    </div>
    <div class="col s12 m8">
      <div class="post-listing">
        
        <div class="container" id="mobile-panel">
          

          <main id="main" class="main">
            <div class="content-wrapper">
              <div id="content" class="content">
                <article class="post inner">
    <a class="home-btn" href= "https://xguox.me/" >
      Home
    </a>
    
    <header class="post-header">
      <h1 class="post-title">ç»™ Ruby on Rails æé€Ÿ</h1>

      <div class="post-meta">
        <span class="post-time"> 25 Dec 2011 </span>
          <span class="more-meta"> 5214 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
      <div class="post-category">
          <a href="/categories/ruby/"> Ruby </a>
          </div>
    </header>

    
    <div class="post-content">
      

<p><a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html">Repost</a></p>

<p>Ruby è¯­è¨€å¸¸ä»¥å…¶çµæ´»æ€§ä¸ºäººæ‰€ç§°é“.æ­£å¦‚ Dick Sites æ‰€è¨€,æ‚¨å¯ä»¥ &ldquo;ä¸ºäº†ç¼–ç¨‹è€Œç¼–ç¨‹&rdquo;.Ruby on Rails æ‰©å±•äº†æ ¸å¿ƒ Ruby è¯­è¨€,ä½†æ­£æ˜¯ Ruby æœ¬èº«ä½¿å¾—è¿™ç§æ‰©å±•æˆä¸ºäº†å¯èƒ½.Ruby on Rails ä½¿ç”¨äº†è¯¥è¯­è¨€çš„çµæ´»æ€§,è¿™æ ·ä¸€æ¥,æ— éœ€å¤ªå¤šæ ·æ¿æˆ–é¢å¤–çš„ä»£ç å°±å¯ä»¥è½»æ¾ç¼–å†™é«˜åº¦ç»“æ„åŒ–çš„ç¨‹åº:æ— éœ€é¢å¤–å·¥ä½œ,å°±å¯ä»¥è·å¾—å¤§é‡æ ‡å‡†çš„è¡Œä¸º.è™½ç„¶è¿™ç§è½»æ¾è‡ªç”±çš„è¡Œä¸ºå¹¶ä¸æ€»æ˜¯å®Œç¾çš„,ä½†æ¯•ç«Ÿæ‚¨å¯ä»¥æ— éœ€å¤ªå¤šå·¥ä½œå°±å¯ä»¥è·å¾—å¾ˆå¤šå¥½çš„æ¶æ„.</p>

<p>ä¾‹å¦‚,Ruby on Rails åŸºäºæ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨(Model-View-Controller,MVC)æ¨¡å¼,è¿™æ„å‘³ç€å¤§å¤šæ•° Rails åº”ç”¨ç¨‹åºéƒ½å¯ä»¥æ¸…æ™°åœ°åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†.æ¨¡å‹éƒ¨åˆ†åŒ…å«äº†ç®¡ç†åº”ç”¨ç¨‹åºæ•°æ®æ‰€éœ€çš„è¡Œä¸º.é€šå¸¸,åœ¨ä¸€ä¸ª Ruby on Rails åº”ç”¨ç¨‹åºä¸­,æ¨¡å‹å’Œæ•°æ®åº“è¡¨ä¹‹é—´çš„å…³ç³»æ˜¯ 1:1ï¼›Ruby on Rails é»˜è®¤ä½¿ç”¨çš„å¯¹è±¡å…³ç³»æ˜ å°„(ORM)ActiveRecord è´Ÿè´£ç®¡ç†æ¨¡å‹ä¸æ•°æ®åº“çš„äº¤äº’,è¿™æ„å‘³ç€ Ruby on Rails ç¨‹åºé€šå¸¸éƒ½å…·æœ‰(å¦‚æœæœ‰çš„è¯)å¾ˆå°‘é‡çš„ SQL ä»£ç .ç¬¬äºŒä¸ªéƒ¨åˆ†æ˜¯è§†å›¾,å®ƒåŒ…å«åˆ›å»ºå‘é€è‡³ç”¨æˆ·çš„è¾“å‡ºæ‰€éœ€è¦çš„ä»£ç ï¼›å®ƒé€šå¸¸ç”± HTMLã€JavaScript ç­‰ç»„æˆ.æœ€åçš„ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ§åˆ¶å™¨,å®ƒå°†æ¥è‡ªç”¨æˆ·çš„è¾“å…¥è½¬å˜ä¸ºæ­£ç¡®çš„æ¨¡å‹,ç„¶åä½¿ç”¨é€‚å½“çš„è§†å›¾å‘ˆç°å“åº”.</p>

<p>Rails çš„å€¡å¯¼è€…é€šå¸¸éƒ½ä¹äºå°†å…¶æ˜“ç”¨æ€§æ–¹é¢çš„æé«˜å½’åŠŸäº MVC èŒƒå‹ â€” ä»¥åŠ Ruby å’Œ Rails äºŒè€…çš„å…¶ä»–ä¸€äº›ç‰¹æ€§,å¹¶ç§°å¾ˆå°‘æœ‰ç¨‹åºå‘˜èƒ½å¤Ÿåœ¨è¾ƒçŸ­çš„æ—¶é—´å†…åˆ›å»ºæ›´å¤šçš„åŠŸèƒ½.å½“ç„¶,è¿™æ„å‘³ç€æŠ•å…¥åˆ°è½¯ä»¶å¼€å‘çš„æˆæœ¬å°†èƒ½å¤Ÿäº§ç”Ÿæ›´å¤šçš„å•†ä¸šä»·å€¼,å› æ­¤ Ruby on Rails å¼€å‘æ„ˆå‘æµè¡Œ.</p>

<p>ä¸è¿‡,æœ€åˆçš„å¼€å‘æˆæœ¬å¹¶ä¸æ˜¯äº‹æƒ…çš„å…¨éƒ¨,è¿˜æœ‰å…¶ä»–çš„åç»­æˆæœ¬éœ€è¦è€ƒè™‘,æ¯”å¦‚åº”ç”¨ç¨‹åºè¿è¡Œçš„ç»´æŠ¤æˆæœ¬å’Œç¡¬ä»¶æˆæœ¬.Ruby on Rails å¼€å‘äººå‘˜é€šå¸¸ä¼šä½¿ç”¨æµ‹è¯•å’Œå…¶ä»–çš„æ•æ·å¼€å‘æŠ€æœ¯æ¥é™ä½ç»´æŠ¤æˆæœ¬,ä½†æ˜¯è¿™æ ·ä¸€æ¥,å¾ˆå®¹æ˜“å¿½è§†å…·æœ‰å¤§é‡æ•°æ®çš„ Rails åº”ç”¨ç¨‹åºçš„æœ‰æ•ˆè¿è¡Œ.è™½ç„¶ Rails èƒ½å¤Ÿç®€åŒ–å¯¹æ•°æ®åº“çš„è®¿é—®,ä½†å®ƒå¹¶ä¸æ€»æ˜¯èƒ½å¤Ÿå¦‚æ­¤æœ‰æ•ˆ.</p>

<h2 id="rails-åº”ç”¨ç¨‹åºä¸ºä½•è¿è¡Œç¼“æ…¢">Rails åº”ç”¨ç¨‹åºä¸ºä½•è¿è¡Œç¼“æ…¢?</h2>

<p>Rails åº”ç”¨ç¨‹åºä¹‹æ‰€ä»¥è¿è¡Œç¼“æ…¢,å…¶ä¸­æœ‰å‡ ä¸ªå¾ˆåŸºæœ¬çš„åŸå› .ç¬¬ä¸€ä¸ªåŸå› å¾ˆç®€å•:Rails æ€»æ˜¯ä¼šåšä¸€äº›å‡è®¾ä¸ºæ‚¨åŠ é€Ÿå¼€å‘.é€šå¸¸,è¿™ç§å‡è®¾æ˜¯æ­£ç¡®è€Œæœ‰å¸®åŠ©çš„.ä¸è¿‡,å®ƒä»¬å¹¶ä¸æ€»èƒ½æœ‰ç›Šäºæ€§èƒ½,å¹¶ä¸”è¿˜ä¼šå¯¼è‡´èµ„æºä½¿ç”¨çš„æ•ˆç‡ä½ä¸‹ â€” å°¤å…¶æ˜¯æ•°æ®åº“èµ„æº.</p>

<p>ä¾‹å¦‚,ä½¿ç”¨ç­‰åŒäº <code>SELECT *</code>çš„ä¸€ä¸ª SQL è¯­å¥,ActiveRecord ä¼šé»˜è®¤é€‰æ‹©æŸ¥è¯¢ä¸Šçš„æ‰€æœ‰å­—æ®µ.åœ¨å…·æœ‰ä¸ºæ•°ä¼—å¤šçš„åˆ—çš„æƒ…å†µä¸‹ â€” å°¤å…¶æ˜¯å½“æœ‰äº›å­—æ®µæ˜¯å·¨å¤§çš„ VARCHAR æˆ– BLOB å­—æ®µæ—¶ â€” å°±å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½è€Œè¨€è¿™ç§è¡Œä¸ºå¾ˆæœ‰é—®é¢˜.</p>

<p>å¦ä¸€ä¸ªæ˜¾è‘—çš„æŒ‘æˆ˜æ˜¯ <strong>N+1</strong> é—®é¢˜,æœ¬æ–‡å°†å¯¹æ­¤è¿›è¡Œè¯¦ç»†çš„æ¢è®¨.è¿™ä¼šå¯¼è‡´å¾ˆå¤šå°æŸ¥è¯¢çš„æ‰§è¡Œ,è€Œä¸æ˜¯ä¸€ä¸ªå•ä¸€çš„å¤§æŸ¥è¯¢.ä¾‹å¦‚,ActiveRecord æ— ä»çŸ¥é“ä¸€ç»„çˆ¶è®°å½•ä¸­çš„å“ªä¸€ä¸ªä¼šè¯·æ±‚ä¸€ä¸ªå­è®°å½•,æ‰€ä»¥å®ƒä¼šä¸ºæ¯ä¸ªçˆ¶è®°å½•ç”Ÿæˆä¸€ä¸ªå­è®°å½•æŸ¥è¯¢.ç”±äºæ¯æŸ¥è¯¢çš„è´Ÿè·,è¿™ç§è¡Œä¸ºå°†å¯¼è‡´æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜.</p>

<p>å…¶ä»–çš„æŒ‘æˆ˜åˆ™æ›´å¤šåœ°ä¸  Ruby on Rails å¼€å‘äººå‘˜çš„å¼€å‘ä¹ æƒ¯å’Œæ€åº¦ç›¸å…³.ç”±äº ActiveRecord èƒ½å¤Ÿè®©å¦‚æ­¤ä¼—å¤šçš„ä»»åŠ¡å˜å¾—è½»è€Œæ˜“ä¸¾,Rails å¼€å‘äººå‘˜å¸¸å¸¸ä¼šå½¢æˆ &ldquo;SQL ä¸æ€æ ·&rdquo; çš„ä¸€ç§æ€åº¦,å³ä¾¿åœ¨æ›´é€‚åˆä½¿ç”¨ SQL çš„æ—¶å€™,ä¹Ÿä¼šé¿å… SQL.åˆ›å»ºå’Œå¤„ç†æ•°é‡å·¨å¤§çš„ ActiveRecord å¯¹è±¡çš„é€Ÿåº¦ä¼šéå¸¸ç¼“æ…¢,æ‰€ä»¥åœ¨æœ‰äº›æƒ…å†µä¸‹,ç›´æ¥ç¼–å†™ä¸€ä¸ªæ— éœ€å®ä¾‹åŒ–ä»»ä½•å¯¹è±¡çš„ SQL æŸ¥è¯¢ä¼šæ›´å¿«äº›.</p>

<p>ç”±äº Ruby on Rails å¸¸è¢«ç”¨æ¥é™ä½å¼€å‘å›¢é˜Ÿçš„è§„æ¨¡,åˆç”±äº Ruby on Rails å¼€å‘äººå‘˜é€šå¸¸éƒ½ä¼šæ‰§è¡Œéƒ¨ç½²å’Œç»´æŠ¤ç”Ÿäº§ä¸­çš„åº”ç”¨ç¨‹åºæ‰€éœ€çš„ä¸€äº›ç³»ç»Ÿç®¡ç†ä»»åŠ¡,å› æ­¤è‹¥å¯¹åº”ç”¨ç¨‹åºçš„ç¯å¢ƒçŸ¥ä¹‹ç”šå°‘,å°±å¾ˆå¯èƒ½å‡ºé—®é¢˜.æ“ä½œç³»ç»Ÿå’Œæ•°æ®åº“æœ‰å¯èƒ½æœªè¢«æ­£ç¡®è®¾ç½®.æ¯”å¦‚,è™½ç„¶å¹¶ä¸æœ€ä¼˜,<code>MySQL my.cnf</code> è®¾ç½®å¸¸å¸¸åœ¨ Ruby on Rails éƒ¨ç½²å†…ä¿ç•™å®ƒä»¬çš„é»˜è®¤è®¾ç½®.æ­¤å¤–,å¯èƒ½è¿˜ä¼šç¼ºå°‘è¶³å¤Ÿçš„ç›‘æ§å’ŒåŸºå‡†æµ‹è¯•å·¥å…·æ¥æä¾›æ€§èƒ½çš„é•¿æœŸçŠ¶å†µ.å½“ç„¶,è¿™å¹¶ä¸æ˜¯åœ¨è´£æ€ª Ruby on Rails å¼€å‘äººå‘˜ï¼›è¿™æ˜¯éä¸“ä¸šåŒ–å¯¼è‡´çš„åæœï¼›åœ¨æœ‰äº›æƒ…å†µä¸‹,Rails å¼€å‘äººå‘˜æœ‰å¯èƒ½æ˜¯è¿™ä¸¤ä¸ªé¢†åŸŸçš„ä¸“å®¶.</p>

<p>æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ Ruby on Rails é¼“åŠ±å¼€å‘äººå‘˜åœ¨æœ¬åœ°ç¯å¢ƒä¸­è¿›è¡Œå¼€å‘.è¿™ä¹ˆåšæœ‰å‡ ä¸ªå¥½å¤„ â€” æ¯”å¦‚,å¼€å‘å»¶è¿Ÿçš„å‡å°‘å’Œåˆ†å¸ƒæ€§çš„æé«˜ â€” ä½†å®ƒå¹¶ä¸æ„å‘³ç€æ‚¨å¯ä»¥å› ä¸ºå·¥ä½œç«™è§„æ¨¡çš„å‡å°‘è€Œåªå¤„ç†æœ‰é™çš„æ•°æ®é›†.ä»–ä»¬å¦‚ä½•å¼€å‘ä»¥åŠä»£ç å°†è¢«éƒ¨ç½²äºä½•å¤„ä¹‹é—´çš„å·®å¼‚å¯èƒ½ä¼šæ˜¯ä¸€ä¸ªå¤§é—®é¢˜.å³ä¾¿æ‚¨åœ¨ä¸€ä¸ªæ€§èƒ½è‰¯å¥½çš„è½»è½½æœ¬åœ°æœåŠ¡å™¨ä¸Šå¤„ç†å°è§„æ¨¡çš„æ•°æ®å·²ç»å¾ˆé•¿ä¸€æ®µæ—¶é—´,ä¹Ÿä¼šå‘ç°å¯¹äºæ‹¥å¡çš„æœåŠ¡å™¨ä¸Šçš„å¤§å‹æ•°æ®æ­¤åº”ç”¨ç¨‹åºä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ€§èƒ½é—®é¢˜.</p>

<p>å½“ç„¶,Rails åº”ç”¨ç¨‹åºå…·æœ‰æ€§èƒ½é—®é¢˜çš„åŸå› å¯èƒ½æœ‰å¾ˆå¤š.æŸ¥å‡º Rails åº”ç”¨ç¨‹åºæœ‰ä½•æ½œåœ¨æ€§èƒ½é—®é¢˜çš„æœ€ä½³æ–¹æ³•æ˜¯,åˆ©ç”¨èƒ½ä¸ºæ‚¨æä¾›å¯é‡å¤ã€å‡†ç¡®åº¦é‡çš„è¯Šæ–­å·¥å…·.</p>

<h2 id="æ£€æµ‹æ€§èƒ½é—®é¢˜">æ£€æµ‹æ€§èƒ½é—®é¢˜</h2>

<p>æœ€å¥½çš„å·¥å…·ä¹‹ä¸€æ˜¯ Rails å¼€å‘æ—¥å¿—,å®ƒé€šå¸¸ä½äºæ¯ä¸ªå¼€å‘æœºå™¨ä¸Šçš„ <code>log/development.log</code> æ–‡ä»¶å†….å®ƒå…·æœ‰å„ç§ç»¼åˆæŒ‡æ ‡:å“åº”è¯·æ±‚æ‰€èŠ±è´¹çš„æ€»æ—¶é—´ã€èŠ±è´¹åœ¨æ•°æ®åº“å†…çš„æ—¶é—´æ‰€å çš„ç™¾åˆ†æ¯”ã€ç”Ÿæˆè§†å›¾æ‰€èŠ±æ—¶é—´çš„ç™¾åˆ†æ¯”ç­‰.æ­¤å¤–,è¿˜æœ‰ä¸€äº›å·¥å…·å¯ç”¨æ¥åˆ†ææ­¤æ—¥å¿—æ–‡ä»¶,æ¯”å¦‚ development-log-analyzer.</p>

<p>åœ¨ç”Ÿäº§æœŸé—´,é€šè¿‡æŸ¥çœ‹ <code>mysql_slow_log</code>å¯ä»¥æ‰¾åˆ°å¾ˆå¤šæœ‰ä»·å€¼çš„ä¿¡æ¯.æ›´ä¸ºå…¨é¢çš„ä»‹ç»è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´,æ›´å¤šä¿¡æ¯å¯ä»¥åœ¨ <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">å‚è€ƒèµ„æ–™ </a>éƒ¨åˆ†æ‰¾åˆ°.</p>

<p>å…¶ä¸­ä¸€ä¸ªæœ€å¼ºå¤§ä¹Ÿæ˜¯æœ€ä¸ºæœ‰ç”¨çš„å·¥å…·æ˜¯ query_reviewer æ’ä»¶(å‚è§ <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">å‚è€ƒèµ„æ–™</a>).è¿™ä¸ªæ’ä»¶å¯æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šæœ‰å¤šå°‘æŸ¥è¯¢åœ¨æ‰§è¡Œä»¥åŠé¡µé¢ç”Ÿæˆéœ€è¦å¤šé•¿æ—¶é—´.å¹¶ä¸”å®ƒè¿˜ä¼šè‡ªåŠ¨åˆ†æ ActiveRecord ç”Ÿæˆçš„ SQL ä»£ç ä»¥ä¾¿å‘ç°æ½œåœ¨é—®é¢˜.ä¾‹å¦‚,å®ƒèƒ½æ‰¾åˆ°ä¸ä½¿ç”¨ MySQL ç´¢å¼•çš„æŸ¥è¯¢,æ‰€ä»¥å¦‚æœæ‚¨å¿˜è®°äº†ç´¢å¼•ä¸€ä¸ªé‡è¦çš„åˆ—å¹¶ç”±æ­¤é€ æˆäº†æ€§èƒ½é—®é¢˜,é‚£ä¹ˆæ‚¨å°†èƒ½å¾ˆå®¹æ˜“åœ°æ‰¾åˆ°è¿™ä¸ªåˆ—(æœ‰å…³ MySQL ç´¢å¼•çš„æ›´å¤šä¿¡æ¯,å‚è§ <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">å‚è€ƒèµ„æ–™</a>).æ­¤æ’ä»¶åœ¨ä¸€ä¸ªå¼¹å‡ºçš„ <code>&lt;div&gt;</code>(åªåœ¨å¼€å‘æ¨¡å¼ä¸‹å¯è§)ä¸­æ˜¾ç¤ºäº†æ‰€æœ‰è¿™ç±»ä¿¡æ¯.</p>

<p>æœ€å,ä¸è¦å¿˜è®°ä½¿ç”¨ç±»ä¼¼ Firebugã€yslowã€Ping å’Œ tracert è¿™æ ·çš„å·¥å…·æ¥æ£€æµ‹æ€§èƒ½é—®é¢˜æ˜¯æ¥è‡ªäºç½‘ç»œè¿˜æ˜¯èµ„æºåŠ è½½é—®é¢˜.</p>

<p>æ¥ä¸‹æ¥,è®©æˆ‘ä»¬æ¥çœ‹å…·ä½“çš„ä¸€äº› Rails æ€§èƒ½é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆ.</p>

<h2 id="n-1-æŸ¥è¯¢é—®é¢˜">N+1 æŸ¥è¯¢é—®é¢˜</h2>

<p>N+1 æŸ¥è¯¢é—®é¢˜æ˜¯ Rails åº”ç”¨ç¨‹åºæœ€å¤§çš„é—®é¢˜ä¹‹ä¸€.ä¾‹å¦‚,æ¸…å• 1 å†…çš„ä»£ç èƒ½ç”Ÿæˆå¤šå°‘æŸ¥è¯¢?æ­¤ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„å¾ªç¯,éå†äº†ä¸€ä¸ªå‡æƒ³çš„ post è¡¨å†…çš„æ‰€æœ‰ post,å¹¶æ˜¾ç¤º post çš„ç±»åˆ«å’Œå®ƒçš„ä¸»ä½“.</p>

<h3 id="æ¸…å•-1-æœªä¼˜åŒ–çš„-post-all-ä»£ç ">æ¸…å• 1. æœªä¼˜åŒ–çš„ Post.all ä»£ç </h3>

<p>{% highlight ruby %}
&lt;%@posts = Post.all(@posts).each do |p|%&gt;
  <h1>&lt;%=p.category.name%&gt;</h1>
  <p>&lt;%=p.body%&gt;</p>
&lt;%end%&gt;
{% endhighlight %}</p>

<p>ç­”æ¡ˆ:ä¸Šè¿°ä»£ç ç”Ÿæˆäº†ä¸€ä¸ªæŸ¥è¯¢å¤–åŠ   <code>@posts</code> å†…çš„æ¯è¡Œä¸€ä¸ªæŸ¥è¯¢.ç”±äºæ¯æŸ¥è¯¢çš„è´Ÿè·,è¿™å¯èƒ½ä¼šæˆä¸ºä¸€ä¸ªå¾ˆå¤§çš„æŒ‘æˆ˜.ç½ªé­ç¥¸é¦–æ˜¯å¯¹ <code>p.category.name</code> çš„è°ƒç”¨.è¿™ä¸ªè°ƒç”¨åªåº”ç”¨äºè¯¥ç‰¹å®šçš„ <code>post</code> å¯¹è±¡,è€Œä¸æ˜¯æ•´ä¸ª <code>@posts</code> æ•°ç»„.å¹¸å¥½,é€šè¿‡ä½¿ç”¨ç«‹å³åŠ è½½,æˆ‘ä»¬å¯ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜.</p>

<p>ç«‹å³åŠ è½½ æ„å‘³ç€ Rails å°†è‡ªåŠ¨æ‰§è¡Œæ‰€éœ€çš„æŸ¥è¯¢æ¥åŠ è½½ä»»ä½•ç‰¹å®šå­å¯¹è±¡çš„å¯¹è±¡.Rails å°†ä½¿ç”¨ä¸€ä¸ª <code>JOIN</code> SQL è¯­å¥æˆ–ä¸€ä¸ªæ‰§è¡Œå¤šä¸ªæŸ¥è¯¢çš„ç­–ç•¥.ä¸è¿‡,å‡è®¾æŒ‡å®šäº†å°†è¦ä½¿ç”¨çš„æ‰€æœ‰å­å¯¹è±¡,é‚£ä¹ˆå°†æ°¸è¿œä¸ä¼šå¯¼è‡´ N+1 çš„æƒ…å½¢,åœ¨ N+1 æƒ…å½¢ä¸‹,ä¸€ä¸ªå¾ªç¯çš„æ¯ä¸ªè¿­ä»£éƒ½ä¼šç”Ÿæˆé¢å¤–çš„ä¸€ä¸ªæŸ¥è¯¢.æ¸…å• 2 æ˜¯å¯¹ æ¸…å• 1 å†…ä»£ç çš„ä¿®è®¢,å®ƒä½¿ç”¨äº†ç«‹å³åŠ è½½æ¥é¿å… N+1 é—®é¢˜.</p>

<h3 id="æ¸…å•-2-ç”¨ç«‹å³åŠ è½½ä¼˜åŒ–åçš„-post-all-ä»£ç ">æ¸…å• 2. ç”¨ç«‹å³åŠ è½½ä¼˜åŒ–åçš„ Post.all ä»£ç </h3>

<p>{% highlight ruby %}
&lt;%@posts = Post.find(:all, :include=&gt;[:category]
  @posts.each do |p|%&gt;
  <h1>&lt;%=p.category.name%&gt;</h1>
  <p>&lt;%=p.body%&gt;</p>
&lt;%end%&gt;
{% endhighlight %}</p>

<p>è¯¥ä»£ç æœ€å¤šç”Ÿæˆä¸¤ä¸ªæŸ¥è¯¢,è€Œä¸ç®¡åœ¨æ­¤ <code>posts</code> è¡¨å†…æœ‰å¤šå°‘è¡Œ.</p>

<p>å½“ç„¶,å¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µéƒ½å¦‚æ­¤ç®€å•.å¤„ç†å¤æ‚çš„ N+1 æŸ¥è¯¢æƒ…å†µéœ€è¦æ›´å¤šçš„å·¥ä½œ.é‚£ä¹ˆåšè¿™ä¹ˆå¤šåŠªåŠ›å€¼å¾—ä¹ˆ?è®©æˆ‘ä»¬æ¥åšä¸€äº›å¿«é€Ÿçš„æµ‹è¯•.</p>

<h2 id="æµ‹è¯•-n-1">æµ‹è¯• N+1</h2>

<p>ä½¿ç”¨æ¸…å• 3 å†…çš„è„šæœ¬,å¯ä»¥å‘ç°æŸ¥è¯¢å¯ä»¥è¾¾åˆ° â€” å¤šæ…¢ â€” æˆ–å¤šå¿«. æ¸…å• 3 å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªç‹¬ç«‹è„šæœ¬ä¸­ä½¿ç”¨ ActiveRecord æ¥å»ºç«‹ä¸€ä¸ªæ•°æ®åº“è¿æ¥ã€å®šä¹‰è¡¨å¹¶åŠ è½½æ•°æ®.ç„¶å,å¯ä»¥ä½¿ç”¨ Ruby çš„å†…ç½®åŸºå‡†æµ‹è¯•åº“æ¥æŸ¥çœ‹å“ªç§æ–¹å¼æ›´å¿«,å¿«å¤šå°‘.</p>

<h3 id="æ¸…å•-3-ç«‹å³åŠ è½½åŸºå‡†æµ‹è¯•è„šæœ¬">æ¸…å• 3. ç«‹å³åŠ è½½åŸºå‡†æµ‹è¯•è„šæœ¬</h3>

<p>{% highlight ruby %}
require &lsquo;Rubygems&rsquo;
require &lsquo;faker&rsquo;
require &lsquo;active_record&rsquo;
require &lsquo;benchmark&rsquo;</p>

<h1 id="this-call-creates-a-connection-to-our-database">This call creates a connection to our database.</h1>

<p>ActiveRecord::Base.establish_connection(
  :adapter  =&gt; &ldquo;mysql&rdquo;,
  :host     =&gt; &ldquo;127.0.0.1&rdquo;,
  :username =&gt; &ldquo;root&rdquo;, # Note that while this is the default setting for MySQL,
  :password =&gt; &ldquo;&rdquo;,     # a properly secured system will have a different MySQL
                            # username and password, and if so, you&rsquo;ll need to
                            # change these settings.
  :database =&gt; &ldquo;test&rdquo;)</p>

<h1 id="first-set-up-our-database">First, set up our database&hellip;</h1>

<p>class Category &lt;  ActiveRecord::Base
end</p>

<p>unless Category.table_exists?
  ActiveRecord::Schema.define do
    create_table :categories do |t|
        t.column :name, :string
    end
  end
end</p>

<p>Category.create(:name=&gt;&lsquo;Sara Campbell\&rsquo;s Stuff&rsquo;)
Category.create(:name=&gt;&lsquo;Jake Moran\&rsquo;s Possessions&rsquo;)
Category.create(:name=&gt;&lsquo;Josh\&rsquo;s Items&rsquo;)
number_of_categories = Category.count</p>

<p>class Item &lt;  ActiveRecord::Base
  belongs_to :category
end</p>

<h1 id="if-the-table-doesn-t-exist-we-ll-create-it">If the table doesn&rsquo;t exist, we&rsquo;ll create it.</h1>

<p>unless Item.table_exists?
  ActiveRecord::Schema.define do
    create_table :items do |t|
        t.column :name, :string
        t.column :category_id, :integer
    end
  end
end</p>

<p>puts &ldquo;Loading data&hellip;&rdquo;</p>

<p>item_count = Item.count
item_table_size = 10000</p>

<p>if item_count &lt; item_table_size
  (item_table_size - item_count).times do
    Item.create!(:name=&gt;Faker.name,
                 :category_id=&gt;(1+rand(number_of_categories.to_i)))
  end
end</p>

<p>puts &ldquo;Running tests&hellip;&rdquo;</p>

<p>Benchmark.bm do |x|
  [100,1000,10000].each do |size|
    x.report &ldquo;size:#{size}, with n+1 problem&rdquo; do
      @items=Item.find(:all, :limit=&gt;size)
      @items.each do |i|
        i.category
      end
    end
    x.report &ldquo;size:#{size}, with :include&rdquo; do
      @items=Item.find(:all, :include=&gt;:category, :limit=&gt;size)
      @items.each do |i|
        i.category
      end
    end
  end
end
{% endhighlight %}</p>

<p>è¿™ä¸ªè„šæœ¬ä½¿ç”¨ <code>:include</code> å­å¥æµ‹è¯•åœ¨æœ‰å’Œæ²¡æœ‰ç«‹å³åŠ è½½çš„æƒ…å†µä¸‹å¯¹ 100ã€1,000 å’Œ 10,000 ä¸ªå¯¹è±¡è¿›è¡Œå¾ªç¯æ“ä½œçš„é€Ÿåº¦å¦‚ä½•.ä¸ºäº†è¿è¡Œæ­¤è„šæœ¬,æ‚¨å¯èƒ½éœ€è¦ç”¨é€‚åˆäºæ‚¨çš„æœ¬åœ°ç¯å¢ƒçš„å‚æ•°æ›¿æ¢æ­¤è„šæœ¬é¡¶éƒ¨çš„è¿™äº›æ•°æ®åº“è¿æ¥å‚æ•°.æ­¤å¤–,éœ€è¦åˆ›å»ºä¸€ä¸ªåä¸º test çš„ MySQL æ•°æ®åº“.æœ€å,æ‚¨è¿˜éœ€è¦ ActiveRecord å’Œ faker è¿™ä¸¤ä¸ª gem,äºŒè€…å¯é€šè¿‡è¿è¡Œ <code>gem install activerecord faker</code> è·å¾—.</p>

<p>åœ¨æˆ‘çš„æœºå™¨ä¸Šè¿è¡Œæ­¤è„šæœ¬ç”Ÿæˆçš„ç»“æœå¦‚æ¸…å• 4 æ‰€ç¤º.</p>

<h3 id="æ¸…å•-4-ç«‹å³åŠ è½½çš„åŸºå‡†æµ‹è¯•è„šæœ¬è¾“å‡º">æ¸…å• 4. ç«‹å³åŠ è½½çš„åŸºå‡†æµ‹è¯•è„šæœ¬è¾“å‡º</h3>

<p>{% highlight ruby %}
&ndash; create_table(:categories)
   -&gt; 0.1327s
&ndash; create_table(:items)
   -&gt; 0.1215s
Loading data&hellip;
Running tests&hellip;
      user     system      total        real
size:100, with n+1 problem  0.030000   0.000000   0.030000 (  0.045996)
size:100, with :include  0.010000   0.000000   0.010000 (  0.009164)
size:1000, with n+1 problem  0.260000   0.040000   0.300000 (  0.346721)
size:1000, with :include  0.060000   0.010000   0.070000 (  0.076739)
size:10000, with n+1 problem  3.110000   0.380000   3.490000 (  3.935518)
size:10000, with :include  0.470000   0.080000   0.550000 (  0.573861)
{% endhighlight %}</p>

<p>åœ¨æ‰€æœ‰æƒ…å†µä¸‹,ä½¿ç”¨ :include çš„æµ‹è¯•æ€»æ˜¯æ›´ä¸ºè¿…é€Ÿ â€” åˆ†åˆ«å¿« 5.02ã€4.52 å’Œ 6.86 å€.å½“ç„¶,å…·ä½“çš„è¾“å‡ºå–å†³äºæ‚¨çš„ç‰¹å®šæƒ…å†µ,ä½†ç«‹å³åŠ è½½å¯æ˜æ˜¾å¯¼è‡´æ˜¾è‘—çš„æ€§èƒ½æ”¹å–„.</p>

<h2 id="åµŒå¥—çš„ç«‹å³åŠ è½½">åµŒå¥—çš„ç«‹å³åŠ è½½</h2>

<p>å¦‚æœæ‚¨æƒ³è¦å¼•ç”¨ä¸€ä¸ªåµŒå¥—çš„å…³ç³» â€” å…³ç³»çš„å…³ç³»,åˆè¯¥å¦‚ä½•å‘¢? æ¸…å• 5 å±•ç¤ºäº†è¿™æ ·ä¸€ä¸ªå¸¸è§çš„æƒ…å½¢:å¾ªç¯éå†æ‰€æœ‰çš„ post å¹¶æ˜¾ç¤ºä½œè€…çš„å›¾åƒ,å…¶ä¸­ Author ä¸ Image æ˜¯ belongs_to çš„å…³ç³».</p>

<h3 id="æ¸…å•-5-åµŒå¥—çš„ç«‹å³åŠ è½½ç”¨ä¾‹">æ¸…å• 5. åµŒå¥—çš„ç«‹å³åŠ è½½ç”¨ä¾‹</h3>

<p>{% highlight ruby %}
@posts = Post.all
@posts.each do |p|
  <h1>&lt;%=p.category.name%&gt;</h1>
  &lt;%=image_tag p.author.image.public_filename %&gt;
  <p>&lt;%=p.body%&gt;
 &lt;%end%&gt;
 {% endhighlight %}</p>

<p>æ­¤ä»£ç ä¸ä¹‹å‰ä¸€æ ·äº¦é­é‡äº†ç›¸åŒçš„ N+1 é—®é¢˜,ä½†ä¿®å¤çš„è¯­æ³•å´æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾,å› ä¸ºè¿™é‡Œæ‰€ä½¿ç”¨çš„æ˜¯å…³ç³»çš„å…³ç³».é‚£ä¹ˆå¦‚ä½•æ‰èƒ½ç«‹å³åŠ è½½åµŒå¥—å…³ç³»å‘¢?</p>

<p>æ­£ç¡®çš„ç­”æ¡ˆæ˜¯ä½¿ç”¨ <code>:include</code> å­å¥çš„å“ˆå¸Œè¯­æ³•.æ¸…å• 6 ç»™å‡ºäº†ä½¿ç”¨å“ˆå¸Œè¯­æ³•çš„ä¸€ä¸ªåµŒå¥—çš„ç«‹å³åŠ è½½.</p>

<h3 id="æ¸…å•-6-åµŒå¥—çš„ç«‹å³åŠ è½½è§£å†³æ–¹æ¡ˆ">æ¸…å• 6. åµŒå¥—çš„ç«‹å³åŠ è½½è§£å†³æ–¹æ¡ˆ</h3>

<p>{% highlight ruby %}
@posts = Post.find(:all, :include=&gt;{ :category=&gt;[],
                                       :author=&gt;{ :image=&gt;[]}} )
@posts.each do |p|
  <h1>&lt;%=p.category.name%&gt;</h1>
  &lt;%=image_tag p.author.image.public_filename %&gt;
  <p>&lt;%=p.body%&gt;
 &lt;%end%&gt;
 {% endhighlight %}</p>

<p>æ­£å¦‚æ‚¨æ‰€è§,æ‚¨å¯ä»¥åµŒå¥—å“ˆå¸Œå’Œæ•°ç»„å®é‡(literal).è¯·æ³¨æ„åœ¨æœ¬ä¾‹ä¸­å“ˆå¸Œå’Œæ•°ç»„ä¹‹é—´çš„æƒŸä¸€åŒºåˆ«æ˜¯å“ˆå¸Œå¯ä»¥å«æœ‰åµŒå¥—çš„å­æ¡ç›®,è€Œæ•°ç»„åˆ™ä¸èƒ½.å¦åˆ™,äºŒè€…æ˜¯ç­‰æ•ˆçš„.</p>

<h2 id="é—´æ¥çš„ç«‹å³åŠ è½½">é—´æ¥çš„ç«‹å³åŠ è½½</h2>

<p>å¹¶éæ‰€æœ‰çš„ N+1 é—®é¢˜éƒ½èƒ½å¾ˆå®¹æ˜“åœ°å¯Ÿè§‰åˆ°.ä¾‹å¦‚,æ¸…å• 7 èƒ½ç”Ÿæˆå¤šå°‘æŸ¥è¯¢?</p>

<h3 id="æ¸…å•-7-é—´æ¥çš„ç«‹å³åŠ è½½ç¤ºä¾‹ç”¨ä¾‹">æ¸…å• 7. é—´æ¥çš„ç«‹å³åŠ è½½ç¤ºä¾‹ç”¨ä¾‹</h3>

<p>{% highlight ruby %}
  &lt;%@user = User.find(5)
    @user.posts.each do |p|%&gt;
      &lt;%=render :partial=&gt;&lsquo;posts/summary&rsquo;,  :locals=&gt;:post=&gt;p
     %&gt; &lt;%end%&gt;
     {% endhighlight %}</p>

<p>å½“ç„¶,å†³å®šæŸ¥è¯¢çš„æ•°é‡éœ€è¦å¯¹ <code>posts/summary</code> partial æœ‰æ‰€äº†è§£.æ¸…å• 8 ä¸­æ˜¾ç¤ºäº†è¿™ä¸ª partial.</p>

<h3 id="æ¸…å•-8-é—´æ¥ç«‹å³åŠ è½½-partial-posts-summary-html-erb">æ¸…å• 8. é—´æ¥ç«‹å³åŠ è½½ partial: posts/_summary.html.erb</h3>

<p><code>&lt;h1&gt;&lt;%=post.user.name%&gt;&lt;/h1&gt;</code>
ä¸å¹¸çš„æ˜¯,ç­”æ¡ˆæ˜¯ <strong>æ¸…å• 7</strong>* å’Œ <strong>æ¸…å• 8</strong>* åœ¨ post å†…æ¯è¡Œç”Ÿæˆä¸€ä¸ªé¢å¤–æŸ¥è¯¢,æŸ¥æ‰¾ç”¨æˆ·çš„åå­— â€” å³ä¾¿ post å¯¹è±¡ç”± ActiveRecord ä»ä¸€ä¸ªå·²åœ¨å†…å­˜ä¸­çš„ User å¯¹è±¡è‡ªåŠ¨ç”Ÿæˆ.ç®€è¨€ä¹‹,Rails å¹¶ä¸èƒ½å…³è”å­è®°å½•ä¸å…¶çˆ¶è®°å½•.
ä¿®å¤æ–¹æ³•æ˜¯ä½¿ç”¨è‡ªå¼•ç”¨çš„ç«‹å³åŠ è½½.åŸºæœ¬ä¸Š,ç”±äº Rails é‡è½½ç”±çˆ¶è®°å½•ç”Ÿæˆçš„å­è®°å½•,æ‰€ä»¥éœ€è¦ç«‹å³åŠ è½½è¿™äº›çˆ¶è®°å½•,å°±å¦‚åŒçˆ¶ä¸å­è®°å½•ä¹‹é—´æ˜¯å®Œå…¨åˆ†å¼€çš„å…³ç³»ä¸€æ ·.ä»£ç å¦‚æ¸…å• 9 æ‰€ç¤º.</p>

<h3 id="æ¸…å•-9-é—´æ¥çš„ç«‹å³åŠ è½½è§£å†³æ–¹æ¡ˆ">æ¸…å• 9. é—´æ¥çš„ç«‹å³åŠ è½½è§£å†³æ–¹æ¡ˆ</h3>

<p>{% highlight ruby %}
  &lt;%@user = User.find(5, :include=&gt;{:posts=&gt;[:user]})
  &hellip;snip&hellip;
  {% endhighlight %}</p>

<p>è™½ç„¶æœ‰æ‚–äºç›´è§‰,ä½†è¿™ç§æŠ€æœ¯ä¸ä¸Šè¿°æŠ€æœ¯çš„å·¥ä½œåŸç†å¤§è‡´ç›¸ä¼¼.ä½†æ˜¯,å¾ˆå®¹æ˜“ä½¿ç”¨è¿™ç§æŠ€æœ¯è¿›è¡Œè¿‡å¤šçš„åµŒå¥—,å°¤å…¶æ˜¯åœ¨ä½“ç³»ç»“æ„å¤æ‚çš„æƒ…å†µä¸‹.ç®€å•çš„ç”¨ä¾‹è¿˜å¥½,æ¯”å¦‚ æ¸…å• 9 å†…æ‰€ç¤ºçš„,ä½†ç¹å¤çš„åµŒå¥—ä¹Ÿä¼šå‡ºé—®é¢˜.åœ¨ä¸€äº›æƒ…å†µä¸‹,è¿‡å¤šåœ°åŠ è½½ Ruby å¯¹è±¡æœ‰å¯èƒ½ä¼šæ¯”å¤„ç† N+1 é—®é¢˜è¿˜è¦ç¼“æ…¢ â€” å°¤å…¶æ˜¯å½“æ¯ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰è¢«æ•´ä¸ªæ ‘éå†æ—¶.åœ¨è¯¥ç§æƒ…å†µä¸‹,N+1 é—®é¢˜çš„å…¶ä»–è§£å†³æ–¹æ¡ˆå¯èƒ½æ›´ä¸ºé€‚åˆ.</p>

<p>ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ç¼“å­˜æŠ€æœ¯.Rails V2.1 å†…ç½®äº†ç®€å•çš„ç¼“å­˜è®¿é—®.ä½¿ç”¨ Rails.cache.readã€ Rails.cache.write åŠç›¸å…³æ–¹æ³•,å¯ä»¥è½»æ¾åˆ›å»ºè‡ªå·±çš„ç®€å•ç¼“å­˜æœºåˆ¶,å¹¶ä¸”åç«¯å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„å†…å­˜åç«¯ã€ä¸€ä¸ªåŸºäºæ–‡ä»¶çš„åç«¯æˆ–ä¸€ä¸ªåˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡å™¨.åœ¨ <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">å‚è€ƒèµ„æ–™</a> éƒ¨åˆ†å¯ä»¥æ‰¾åˆ°æœ‰å…³ Rails å†…ç½®ç¼“å­˜æ”¯æŒçš„æ›´å¤šä¿¡æ¯.ä½†æ‚¨æ— éœ€åˆ›å»ºè‡ªå·±çš„ç¼“å­˜è§£å†³æ–¹æ¡ˆï¼›æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé¢„ç½®çš„ Rails æ’ä»¶,æ¯”å¦‚ Nick Kallen çš„ cache money æ’ä»¶.è¿™ä¸ªæ’ä»¶æä¾›äº† write-through ç¼“å­˜å¹¶ä»¥ Twitter ä¸Šä½¿ç”¨çš„ä»£ç ä¸ºåŸºç¡€.æ›´å¤šä¿¡æ¯å‚è§ <a href="http://www.ibm.com/developerworks/cn/opensource/os-Railsn1/index.html#resources">å‚è€ƒèµ„æ–™</a>.</p>

<p>å½“ç„¶,å¹¶ä¸æ˜¯æ‰€æœ‰çš„ Rails é—®é¢˜éƒ½ä¸æŸ¥è¯¢çš„æ•°é‡æœ‰å…³.</p>

<h2 id="rails-åˆ†ç»„å’Œèšåˆè®¡ç®—">Rails åˆ†ç»„å’Œèšåˆè®¡ç®—</h2>

<p>æ‚¨å¯èƒ½é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯åœ¨ Ruby æ‰€åšçš„å·¥ä½œæœ¬åº”ç”±æ•°æ®åº“å®Œæˆ.è¿™è€ƒéªŒäº† Ruby çš„å¼ºå¤§ç¨‹åº¦.å¾ˆéš¾æƒ³è±¡åœ¨æ²¡æœ‰ä»»ä½•é‡å¤§æ¿€åŠ±çš„æƒ…å†µä¸‹äººä»¬ä¼šè‡ªæ„¿åœ¨ C ä¸­é‡æ–°å®ç°å…¶æ•°æ®åº“ä»£ç çš„å„ä¸ªéƒ¨åˆ†,ä½†å¾ˆå®¹æ˜“åœ¨ Rails å†…å¯¹ ActiveRecord å¯¹è±¡ç»„è¿›è¡Œç±»ä¼¼çš„è®¡ç®—.ä½†æ˜¯,Ruby æ€»æ˜¯è¦æ¯”æ•°æ®åº“ä»£ç æ…¢.æ‰€ä»¥è¯·ä¸è¦ä½¿ç”¨çº¯ Ruby çš„æ–¹å¼æ‰§è¡Œè®¡ç®—,å¦‚æ¸…å• 10 æ‰€ç¤º.</p>

<h3 id="æ¸…å•-10-æ‰§è¡Œåˆ†ç»„è®¡ç®—çš„ä¸æ­£ç¡®æ–¹å¼">æ¸…å• 10. æ‰§è¡Œåˆ†ç»„è®¡ç®—çš„ä¸æ­£ç¡®æ–¹å¼</h3>

<p>{% highlight ruby %}
 all_ages = Person.find(:all).group_by(&amp;:age).keys.uniq
  oldest_age = Person.find(:all).max
  {% endhighlight %}</p>

<p>ç›¸å,Rails æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†ç»„å’Œèšåˆå‡½æ•°.å¯ä»¥åƒæ¸…å• 11 æ‰€ç¤ºçš„é‚£æ ·ä½¿ç”¨å®ƒä»¬.</p>

<h3 id="æ¸…å•-11-æ‰§è¡Œåˆ†ç»„è®¡ç®—çš„æ­£ç¡®æ–¹å¼">æ¸…å• 11. æ‰§è¡Œåˆ†ç»„è®¡ç®—çš„æ­£ç¡®æ–¹å¼</h3>

<p>{% highlight ruby %}
 all_ages = Person.find(:all, :group=&gt;[:age])
  oldest_age = Person.calcuate(:max, :age)
  {% endhighlight %}
ActiveRecord::Base#find æœ‰å¤§é‡é€‰é¡¹å¯ç”¨äºæ¨¡ä»¿ SQL.æ›´å¤šä¿¡æ¯å¯ä»¥åœ¨ Rails æ–‡æ¡£å†…æ‰¾åˆ°.æ³¨æ„,calculate æ–¹æ³•å¯é€‚ç”¨äºå—æ•°æ®åº“æ”¯æŒçš„ä»»ä½•æœ‰æ•ˆçš„èšåˆå‡½æ•°,æ¯”å¦‚ <code>:min</code>ã€<code>:sum</code> å’Œ <code>:avg</code>.æ­¤å¤–,calculate èƒ½å¤Ÿæ¥å—è‹¥å¹²å®å‚,æ¯”å¦‚ <code>:conditions</code>.æŸ¥é˜… Rails æ–‡æ¡£ä»¥è·å¾—æ›´è¯¦ç»†çš„ä¿¡æ¯.</p>

<p>ä¸è¿‡,å¹¶ä¸æ˜¯åœ¨ SQL å†…èƒ½åšçš„æ‰€æœ‰äº‹æƒ…åœ¨ Rails å†…ä¹Ÿèƒ½åš.å¦‚æœæ’ä»¶ä¸å¤Ÿ,å¯ä»¥ä½¿ç”¨å®šåˆ¶ SQL.</p>

<h2 id="ç”¨-rails-å®šåˆ¶-sql">ç”¨ Rails å®šåˆ¶ SQL</h2>

<p>å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªè¡¨,å†…å«äººçš„èŒä¸šã€å¹´é¾„ä»¥åŠåœ¨è¿‡å»ä¸€å¹´ä¸­æ¶‰åŠåˆ°ä»–ä»¬çš„äº‹æ•…çš„æ•°é‡.å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå®šåˆ¶  SQL è¯­å¥æ¥æ£€ç´¢æ­¤ä¿¡æ¯,å¦‚æ¸…å• 12 æ‰€ç¤º.</p>

<h3 id="æ¸…å•-12-ç”¨-activerecord-å®šåˆ¶-sql-çš„ä¾‹å­">æ¸…å• 12. ç”¨ ActiveRecord å®šåˆ¶ SQL çš„ä¾‹å­</h3>

<p>{% highlight ruby %}
sql = &ldquo;SELECT profession,
              AVG(age) as average_age,
              AVG(accident_count)
         FROM persons
        GROUP
           BY profession&rdquo;</p>

<p>Person.find_by_sql(sql).each do |row|
  puts &ldquo;#{row.profession}, &rdquo; &lt;&lt;
       &ldquo;avg. age: #{row.average_age}, &ldquo; &lt;&lt;
       &ldquo;avg. accidents: #{row.average_accident_count}&rdquo;
end
{% endhighlight %}</p>

<p>è¿™ä¸ªè„šæœ¬åº”è¯¥èƒ½ç”Ÿæˆæ¸…å• 13 æ‰€ç¤ºçš„ç»“æœ.</p>

<h3 id="æ¸…å•-13-ç”¨-activerecord-å®šåˆ¶-sql-çš„è¾“å‡º">æ¸…å• 13. ç”¨ ActiveRecord å®šåˆ¶ SQL çš„è¾“å‡º</h3>

<p>{% highlight ruby %}
  Programmer, avg. age: 18.010, avg. accidents: 9
  System Administrator, avg. age: 22.720, avg. accidents: 8
  {% endhighlight %}
å½“ç„¶,è¿™æ˜¯æœ€ç®€å•çš„ä¾‹å­.æ‚¨å¯ä»¥è‡ªå·±æƒ³è±¡ä¸€ä¸‹å¦‚ä½•èƒ½å°†æ­¤ä¾‹ä¸­çš„ SQL æ‰©å±•æˆä¸€ä¸ªæœ‰äº›å¤æ‚æ€§çš„ SQL è¯­å¥.æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ <code>ActiveRecord::Base.connection.execute</code> æ–¹æ³•è¿è¡Œå…¶ä»–ç±»å‹çš„ SQL è¯­å¥,æ¯”å¦‚ ALTER TABLE è¯­å¥,å¦‚æ¸…å• 14 æ‰€ç¤º.</p>

<h3 id="æ¸…å•-14-ç”¨-activerecord-å®šåˆ¶éæŸ¥æ‰¾å‹-sql">æ¸…å• 14. ç”¨ ActiveRecord å®šåˆ¶éæŸ¥æ‰¾å‹ SQL</h3>

<p>{% highlight ruby %}
  ActiveRecord::Base.connection.execute &ldquo;ALTER TABLE some_table CHANGE COLUMN&hellip;&rdquo;
  {% endhighlight %}</p>

<p>å¤§å¤šæ•°çš„æ¨¡å¼æ“ä½œ,æ¯”å¦‚æ·»åŠ å’Œåˆ é™¤åˆ—,éƒ½å¯ä»¥ä½¿ç”¨ Rails çš„å†…ç½®æ–¹æ³•å®Œæˆ.ä½†å¦‚æœéœ€è¦,ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰§è¡Œä»»æ„ SQL ä»£ç çš„èƒ½åŠ›.</p>

<p>##ç»“æŸè¯­</p>

<p>ä¸æ‰€æœ‰çš„æ¡†æ¶ä¸€æ ·,å¦‚æœä¸å¤šåŠ å°å¿ƒå’Œæ³¨æ„,Ruby on Rails ä¹Ÿä¼šé­é‡æ€§èƒ½é—®é¢˜.æ‰€å¹¸çš„æ˜¯,ç›‘æ§å’Œä¿®å¤è¿™äº›é—®é¢˜çš„æŠ€æœ¯ç›¸å¯¹ç®€å•ä¸”æ˜“å­¦,è€Œä¸”å³ä¾¿æ˜¯å¤æ‚çš„é—®é¢˜,åªè¦æœ‰è€å¿ƒå¹¶å¯¹æ€§èƒ½é—®é¢˜çš„æºå¤´æœ‰æ‰€äº†è§£,ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„.</p>

    </div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ruby/">Ruby</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/my-first-post-of-octopress.html/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Hello Octopress!</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/proc-vs-lambda.html/">
            <span class="next-text nav-default">Lambda å’Œ Proc çš„åŒºåˆ«åœ¨å“ªå„¿</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
              </div>
              <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xguox';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            </div>
          </main>

          <footer id="footer" class="footer">
            <div class="social-links">
      <a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a>
  <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy;
    2011 -
    2019
    <span class="heart">
      <i class="iconfont icon-bulb"></i>
    </span>
    <span class="author">XguoX</span>
  </span>
</div>
          </footer>

          <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.733a52a9.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62252083-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
