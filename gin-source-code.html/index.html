<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ä» net/http å…¥é—¨åˆ° Gin æºç æ¢³ç† - XguoX - å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="XguoX" /><meta name="description" content="é€šè¿‡ Go çš„æ ‡å‡†åº“ net/http å¯ä»¥è½»æ¾å‡ è¡Œè¿è¡Œèµ·ä¸€ä¸ªç®€å•çš„ web æœåŠ¡, æ¯”å¦‚: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import &amp;#34;net/http&amp;#34; func main() { http.Handle(&amp;#34;/&amp;#34;, &amp;amp;MyHandler{}) http.Handle(&amp;#34;/hello&amp;#34;, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(&amp;#34;world&amp;#34;)) })) http.HandleFunc(&amp;#34;/ping&amp;#34;," /><meta name="keywords" content="Ruby, Golang, Erlang, å‰ç«¯, åç«¯, Android, Elasticsearch, Programmer, Photo, Lens, Camera, Sony, A7r, Fujifilm, Lego" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://xguox.me/gin-source-code.html/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3eafe5cf.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ä» net/http å…¥é—¨åˆ° Gin æºç æ¢³ç†" />
<meta property="og:description" content="é€šè¿‡ Go çš„æ ‡å‡†åº“ net/http å¯ä»¥è½»æ¾å‡ è¡Œè¿è¡Œèµ·ä¸€ä¸ªç®€å•çš„ web æœåŠ¡, æ¯”å¦‚: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import &#34;net/http&#34; func main() { http.Handle(&#34;/&#34;, &amp;MyHandler{}) http.Handle(&#34;/hello&#34;, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(&#34;world&#34;)) })) http.HandleFunc(&#34;/ping&#34;," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xguox.me/gin-source-code.html/" />
<meta property="article:published_time" content="2019-01-10T16:01:23&#43;08:00"/>
<meta property="article:modified_time" content="2019-01-10T16:01:23&#43;08:00"/>

<meta itemprop="name" content="ä» net/http å…¥é—¨åˆ° Gin æºç æ¢³ç†">
<meta itemprop="description" content="é€šè¿‡ Go çš„æ ‡å‡†åº“ net/http å¯ä»¥è½»æ¾å‡ è¡Œè¿è¡Œèµ·ä¸€ä¸ªç®€å•çš„ web æœåŠ¡, æ¯”å¦‚: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import &#34;net/http&#34; func main() { http.Handle(&#34;/&#34;, &amp;MyHandler{}) http.Handle(&#34;/hello&#34;, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(&#34;world&#34;)) })) http.HandleFunc(&#34;/ping&#34;,">


<meta itemprop="datePublished" content="2019-01-10T16:01:23&#43;08:00" />
<meta itemprop="dateModified" content="2019-01-10T16:01:23&#43;08:00" />
<meta itemprop="wordCount" content="1820">



<meta itemprop="keywords" content="Go," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä» net/http å…¥é—¨åˆ° Gin æºç æ¢³ç†"/>
<meta name="twitter:description" content="é€šè¿‡ Go çš„æ ‡å‡†åº“ net/http å¯ä»¥è½»æ¾å‡ è¡Œè¿è¡Œèµ·ä¸€ä¸ªç®€å•çš„ web æœåŠ¡, æ¯”å¦‚: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package main import &#34;net/http&#34; func main() { http.Handle(&#34;/&#34;, &amp;MyHandler{}) http.Handle(&#34;/hello&#34;, http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { w.Write([]byte(&#34;world&#34;)) })) http.HandleFunc(&#34;/ping&#34;,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div class="row">
    <div class="col s12 m4">
      <div class="table cover">
        <div class="cover-card table-cell table-middle">

  <img src="/img/logo.jpeg" alt="" class="avatar">

  <a href="https://xguox.me/" class="author_name">XguoX</a>
  <span class="author_job">å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</span>
  <span class="author_bio mbm"> ğŸ¨ é•¿è‰å­¦ç”»ç”» ... </span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://xguox.me/">home</a>
        <span>/</span>
      </li>

      <li class="nav-item">
        <a href="https://xguox.me/post/">Archive</a>

          <span>/</span>

      </li>

      <li class="nav-item">
        <a href="https://xguox.me/categories/">Categories</a>
      </li>

    </ul>
  </nav>

  <div class="social-links">
    <ul>
        <li><a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a></li>
        <li><a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a></li>
        <li><a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a></li>
    <li>
      <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
    </li>
    </ul>
  </div>

  <section id="js-search" class="p-3 p-lg-5 d-flex flex-column">
    <div class="my-auto" >
      <form action="https://xguox.me/search">
        <input id="search-query" name="s" placeholder="~$ enter to search"/>
      </form>
    </div>
  </section>
</div>
      </div>
    </div>
    <div class="col s12 m8">
      <div class="post-listing">
        
        <div class="container" id="mobile-panel">
          

          <main id="main" class="main">
            <div class="content-wrapper">
              <div id="content" class="content">
                <article class="post inner">
    <a class="home-btn" href= "https://xguox.me/" >
      Home
    </a>
    
    <header class="post-header">
      <h1 class="post-title">ä» net/http å…¥é—¨åˆ° Gin æºç æ¢³ç†</h1>

      <div class="post-meta">
        <span class="post-time"> 10 Jan 2019 </span>
          <span class="more-meta"> 1820 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
      <div class="post-category">
          <a href="/categories/go/"> Go </a>
          </div>
    </header>

    
    <div class="post-content">
      

<p>é€šè¿‡ Go çš„æ ‡å‡†åº“ <code>net/http</code> å¯ä»¥è½»æ¾å‡ è¡Œè¿è¡Œèµ·ä¸€ä¸ªç®€å•çš„ web æœåŠ¡, æ¯”å¦‚:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;net/http&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">MyHandler</span><span class="p">{})</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;world&#34;</span><span class="p">))</span>
    <span class="p">}))</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="nx">hello</span><span class="p">)</span>

    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">hello</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;pong&#34;</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">MyHandler</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">MyHandler</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;MyHandler ServeHTTP&#34;</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>ä¸Šé¢è¿™æ®µä»£ç åˆ†åˆ«ç”¨äº†ä¸å¤ªä¸€æ ·çš„æ–¹å¼æ³¨å†Œäº†ä¸‰ä¸ªç®€å•çš„è·¯ç”±è·¯å¾„åŠç›¸åº”çš„è¯·æ±‚å¤„ç†. è¯´ä¸å¤ªä¸€æ ·å…¶å®è¿˜æ˜¯æœ‰å…±é€šçš„åœ°æ–¹çš„.
å…¶å®å°±æ˜¯ä¸¤ä¸ª <code>net/http</code> åŒ…é‡Œè¾¹çš„å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">HandleFunc</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ¥å—ä¸¤ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªéƒ½æ˜¯è¯·æ±‚çš„è·¯å¾„ pattern, <strong>Handle</strong> çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å®ç°äº† <strong>Handler</strong> æ¥å£çš„ç±»å‹, <strong>HandleFunc</strong> çš„ç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯ä¸€ä¸ª<strong>å‡½æ•°ç±»å‹çš„å‚æ•°</strong>, åªè¦ä¼ å…¥çš„å‡½æ•°ç­¾åæ˜¯ <code>func(http.ResponseWriter, *http.Request)</code> å°±å¯ä»¥äº†. æ‰€ä»¥, å…¶å®ç¬¬ä¸‰ä¸ªè·¯ç”±æ–¹å¼è¿˜å¯ä»¥å†™æˆä¸‹é¢è¿™æ ·:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">m</span> <span class="o">:=</span> <span class="nx">MyHandler</span><span class="p">{}</span>
<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">)</span>
<span class="o">//</span> <span class="nx">ServeHTTP</span> <span class="nx">çš„ç­¾åèƒ½åŒ¹é…å¾—ä¸Š</span></code></pre></td></tr></table>
</div>
</div>
<p>å³ä½¿ç¬¬äºŒä¸ªå‚æ•°ä¸ä¸€æ ·, ä½†å®é™…è¦åšçš„äº‹æƒ…è¿˜æ˜¯ä¸€æ ·çš„, æœ€åéƒ½æ˜¯ä¸¢ç»™ <strong>DefaultServeMux</strong> å®Œæˆè¯·æ±‚çš„å¤„ç†.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nf">HandleFunc</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">handler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;http: nil handler&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">handler</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æ¯”è¾ƒç‰¹åˆ«ä¸€äº›çš„æ˜¯ç¬¬äºŒä¸ªè·¯ç”±,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;world&#34;</span><span class="p">))</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™é‡ŒæŠŠä¸€ä¸ªåŒ¿åå‡½æ•°è½¬æ¢æˆä¸ºäº† <strong>http.HandlerFunc</strong> ç±»å‹, è€Œ <strong>http.HandlerFunc</strong> ç±»å‹å®ç°äº† <strong>http.Handler</strong>, å› æ­¤, ä¹Ÿæ˜¯ä¸€ä¸ªæ­£ç¡®çš„ä½¿ç”¨æ–¹å¼.</p>

<p><strong>http.HandlerFunc</strong> æ˜¯ä¸€ä¸ªç­‰ä»·äº <code>func(ResponseWriter, *Request)</code> çš„ç±»å‹. (<a href="https://xguox.me/go-type-alias-vs-type-definition.html">æ¯æ¬¡çœ‹åˆ°è¿™ç±»å†™æ³•éƒ½è¦ç»†ç»†æƒ³ä¸€ä¸‹æ˜¯ç±»å‹å®šä¹‰è¿˜æ˜¯ç±»å‹åˆ«å, ä»¥åŠæœ‰å•¥ä¸ä¸€æ ·, ç„¶å&hellip;åˆæ…¢æ…¢çš„å¿˜äº†</a>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// The HandlerFunc type is an adapter to allow the use of
</span><span class="c1">// ordinary functions as HTTP handlers. If f is a function
</span><span class="c1">// with the appropriate signature, HandlerFunc(f) is a
</span><span class="c1">// Handler that calls f.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span>

<span class="c1">// ServeHTTP calls f(w, r).
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">f</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<hr />

<h4 id="gin">Gin</h4>

<p><a href="https://github.com/gin-gonic/gin">Gin</a> æ˜¯åŸºäº <code>net/http</code> çš„ web framework(ç¡®åˆ‡ä¸€ä¸¢è¯´æ˜¯åŸºäº <a href="https://github.com/julienschmidt/httprouter">httprouter</a>). ç›¸è¾ƒäº <code>net/http</code> é»˜è®¤çš„è·¯ç”±åŠŸèƒ½, <strong>httprouter</strong> æä¾›äº†æ›´å¥½çš„æ‹“å±•æ€§(<a href="https://xguox.me/gin-router-conflicts.html">åŸºäº trie çš„è·¯ç”±ç»“æ„</a>). <strong>httprouter</strong> çš„ github ä¸»é¡µä¸Šå¼ºè°ƒäº†å‡ æ¬¡ <strong>scale</strong>, P.S. è¿™é‡Œ<a href="https://blog.merovius.de/2017/06/18/how-not-to-use-an-http-router.html">æœ‰ä¸€ç¯‡ç«™é˜Ÿ <code>net/http</code> çš„è·¯ç”±åŠŸèƒ½çš„æ–‡ç« </a>).</p>

<p>ç±»ä¼¼ä¸Šé¢çš„ä¸‰ä¸ªè¯·æ±‚æœåŠ¡, ä¸‹é¢æ˜¯ç”¨ Gin æ‰€å†™çš„ç‰ˆæœ¬(æ²¡æœ‰ä½¿ç”¨ä»»ä½• middleware)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
    <span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;gin home page&#34;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;pong&#34;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;world&#34;</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>ä¸¢å®Œç¤ºä¾‹ä»¥å, è·Ÿç€ç¤ºä¾‹ä»£ç å¤§æ¦‚çš„èµ°ä¸€é Gin çš„å…¨æµç¨‹. ä¹‹ååœ¨æ·±å…¥çœ‹ RouterGroup å’Œ middleware ç›¸å…³çš„æ¢ç©¶.</p>

<hr />

<p>ç¤ºä¾‹ä»£ç ç”¨çš„æ˜¯ <code>gin.New()</code> åˆå§‹åŒ–å¾—åˆ°ä¸€ä¸ª <code>*gin.Engine</code>, è¿™ä¸ª Engine æ˜¯ä¸å¸¦ä»»ä½• middleware çš„, æœ‰æ—¶å€™è¿˜ä¼šä½¿ç”¨ <code>gin.Default()</code> æ¥åˆå§‹åŒ–, å…¶å®å°±æ˜¯ç©ºçš„ Engine åŠ ä¸Šäº† <strong>Logger</strong> å’Œ <strong>Recovery</strong> è¿™ä¿© middleware äº†.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Default</span><span class="p">()</span> <span class="o">*</span><span class="nx">Engine</span> <span class="p">{</span>
    <span class="nf">debugPrintWARNINGDefault</span><span class="p">()</span>
    <span class="nx">engine</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
    <span class="nx">engine</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nf">Logger</span><span class="p">(),</span> <span class="nf">Recovery</span><span class="p">())</span>
    <span class="k">return</span> <span class="nx">engine</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>gin.Engine</strong> çš„ç»“æ„ä½“å®šä¹‰:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Engine</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">RouterGroup</span>
    <span class="c1">// ...å¥½å§, çœç•¥ä¸€å¤§ç¥¨
</span><span class="c1"></span>    <span class="nx">trees</span>   <span class="nx">methodTrees</span> <span class="c1">// è·¯ç”± radix trie æ•°ç»„
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>RouterGroup æ˜¯å…¶ä¸­çš„ä¸€ä¸ªåµŒå¥—ç±»å‹, æ‰€ä»¥, å‰é¢çš„ç¤ºä¾‹ä¸­:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;gin home page&#34;</span><span class="p">)</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>ç±»ä¼¼çš„ <code>r.GET</code>, <code>r.POST</code>, <code>r.DELETE</code> å…¶å®è°ƒç”¨çš„æ˜¯ <strong>gin.Engine</strong> ä¸­çš„ <code>RouterGroup</code> å¯¹åº”çš„æ–¹æ³•.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// GET is a shortcut for router.Handle(&#34;GET&#34;, path, handle).
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">GET</span><span class="p">(</span><span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">relativePath</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="nx">HandlersChain</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
    <span class="nx">absolutePath</span> <span class="o">:=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">calculateAbsolutePath</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">)</span>
    <span class="nx">handlers</span> <span class="p">=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">combineHandlers</span><span class="p">(</span><span class="nx">handlers</span><span class="p">)</span>
    <span class="nx">group</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">absolutePath</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">returnObj</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>å¤§æ¦‚å°±æ˜¯æ³¨å†Œè·¯ç”±ç›¸å…³çš„äº‹æƒ…, æ•´ç†å¥½è·¯å¾„, åˆå¹¶ handlers, æœ€ååŠ å…¥åˆ°ç›¸åº”çš„è·¯ç”±è¡¨(radix tree).</p>

<p>ç„¶åå°±æ˜¯, <code>r.Run()</code>,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">addr</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">debugPrintError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}()</span>

    <span class="nx">address</span> <span class="o">:=</span> <span class="nf">resolveAddress</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">&#34;Listening and serving HTTP on %s\n&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">engine</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>å…¶å®å°±è¿˜æ˜¯ <code>net/http</code> çš„é‚£å¥— <code>func ListenAndServe(addr string, handler Handler)</code>, åªä¸è¿‡ä¼ å…¥çš„æ˜¯ <strong>gin.Engine</strong>, æ›¿ä»£äº† <strong>http.DefaultServeMux</strong> (å½“ListenAndServe ç¬¬äºŒä¸ªå‚æ•°ä¸º nil çš„æ—¶å€™).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ServeHTTP conforms to the http.Handler interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">Context</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">req</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

    <span class="nx">engine</span><span class="p">.</span><span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>

    <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>ä¹‹åå°±æ˜¯ <code>net/http</code> åŒ…çš„ <code>server.go</code> é‚£ä¸€å¥—äº†. TCP Scoket çš„ç›‘å¬, è¯·æ±‚ä¸å“åº”.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// net/http/server.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">handler</span><span class="p">}</span>
    <span class="k">return</span> <span class="nx">server</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ListenAndServe</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span> <span class="c1">// ç›‘å¬ TCP(HTTP) çš„è¿æ¥
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">tcpKeepAliveListener</span><span class="p">{</span><span class="nx">ln</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">TCPListener</span><span class="p">)})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">rw</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span> <span class="c1">// é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
</span><span class="c1"></span>        <span class="c1">// ...
</span><span class="c1"></span>        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">newConn</span><span class="p">(</span><span class="nx">rw</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">,</span> <span class="nx">StateNew</span><span class="p">)</span> <span class="c1">// before Serve can return
</span><span class="c1"></span>        <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="c1">// èµ·ä¸€ä¸ª goroutine å¤„ç†æ¥å—çš„è¯·æ±‚
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">readRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
        <span class="c1">// ...
</span><span class="c1"></span>        <span class="nx">serverHandler</span><span class="p">{</span><span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">}.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// serverHandler delegates to either the server&#39;s Handler or
</span><span class="c1">// DefaultServeMux and also handles &#34;OPTIONS *&#34; requests.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">serverHandler</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sh</span> <span class="nx">serverHandler</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">sh</span><span class="p">.</span><span class="nx">srv</span><span class="p">.</span><span class="nx">Handler</span>  <span class="c1">// gin.Engine
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">handler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="p">=</span> <span class="nx">DefaultServeMux</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RequestURI</span> <span class="o">==</span> <span class="s">&#34;*&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&#34;OPTIONS&#34;</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="p">=</span> <span class="nx">globalOptionsHandler</span><span class="p">{}</span>
    <span class="p">}</span>
    <span class="nx">handler</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æœ€åè¿™ä¸ª handler å°±æ˜¯ä¸€è·¯å¸¦è¿›æ¥çš„ <strong>gin.Engine</strong>, å›åˆ°å‰é¢è´´è¿‡çš„ <code>func (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request)</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ServeHTTP conforms to the http.Handler interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">Context</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">req</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

    <span class="nx">engine</span><span class="p">.</span><span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="c1">// é€šè¿‡è¯·æ±‚ method æ‰¾åˆ° engine.trees ä¸­å¯¹åº”çš„æ ‘ -&gt; åœ¨æ ‘ä¸­æŸ¥æ‰¾å¯¹åº”çš„è·¯ç”±, æ‰§è¡Œç›¸å…³çš„ handlers
</span><span class="c1"></span>    <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æ¥ä¸‹æ¥å°±æ˜¯éå¸ƒ Gin é¡¹ç›®çš„ <strong>gin.Context</strong> ç™»åœº. æºç æ³¨é‡Šä¹Ÿè¯´äº†, Context æ˜¯ Gin æœ€é‡è¦çš„ä¸€éƒ¨åˆ†. å®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨ middleware ä¹‹é—´ä¼ é€’å˜é‡, ç®¡ç†æ•´ä¸ªè¯·æ±‚/å“åº”æµç¨‹, æ¯”å¦‚éªŒè¯è¯·æ±‚çš„ JSON ä»¥åŠè¿”å›ä¸€ä¸ª JSON å“åº”ç­‰ç­‰.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Context</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">writermem</span> <span class="nx">responseWriter</span>
    <span class="nx">Request</span>   <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span>
    <span class="nx">Writer</span>    <span class="nx">ResponseWriter</span>

    <span class="nx">Params</span>   <span class="nx">Params</span>
    <span class="nx">handlers</span> <span class="nx">HandlersChain</span>
    <span class="nx">index</span>    <span class="kt">int8</span>

    <span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span>

    <span class="nx">Keys</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>

    <span class="nx">Errors</span> <span class="nx">errorMsgs</span>

    <span class="nx">Accepted</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// ...
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
    <span class="k">for</span> <span class="nx">s</span> <span class="o">:=</span> <span class="nb">int8</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">));</span> <span class="nx">c</span><span class="p">.</span><span class="nx">index</span> <span class="p">&lt;</span> <span class="nx">s</span><span class="p">;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="p">](</span><span class="nx">c</span><span class="p">)</span> <span class="c1">// æ‰§è¡Œ handler
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>å¯ä»¥çœ‹å‡ºå…¶å®ä¸»è¦æ˜¯å¯¹ <code>func(w http.ResponseWriter, r *http.Request)</code> çš„ä¸€ä¸ªå°è£…, å…¶ä¸­ç”¨äºå“åº”çš„ <code>ResponseWriter</code> åŸºäº <code>http.ResponseWriter</code> åšäº†äº›æ‹“å±•.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">responseWriterBase</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Hijacker</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Flusher</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">CloseNotifier</span>

    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">type</span> <span class="nx">responseWriter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
    <span class="nx">size</span>   <span class="kt">int</span>
    <span class="nx">status</span> <span class="kt">int</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>gin.Context</strong> ä¸­çš„ä¸€å¤§ç¥¨è¿”å› Format æ–¹æ³•</p>

<p><img src="http://wx4.sinaimg.cn/large/62fdd4d5gy1fz0q52gh3bj212w14qguf.jpg" alt="" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">String</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">format</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">values</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">render</span><span class="p">.</span><span class="nx">String</span><span class="p">{</span><span class="nx">Format</span><span class="p">:</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">Data</span><span class="p">:</span> <span class="nx">values</span><span class="p">})</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<hr />

<p>Related:</p>

<ul>
<li><a href="https://xguox.me/gin-RouterGroup-and-middleware-walkthrough.html">Gin RouterGroup ä¸ middleware ç›¸å…³æºç </a></li>
<li><a href="https://chai2010.gitbooks.io/advanced-go-programming-book/content/">https://chai2010.gitbooks.io/advanced-go-programming-book/content/</a></li>
<li><a href="https://stackoverflow.com/a/49674486/1251496">https://stackoverflow.com/questions/49668070/how-does-servehttp-work</a></li>
</ul>

    </div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go/">Go</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/gin-routergroup-and-middleware-walkthrough.html/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Gin RouterGroup ä¸ middleware ç›¸å…³æºç </span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/goland-is-awesome-for-reading.html/">
            <span class="next-text nav-default">ç”¨ Goland é˜…è¯»ä»£ç æ˜¯çœŸ 6</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
              </div>
              <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xguox';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            </div>
          </main>

          <footer id="footer" class="footer">
            <div class="social-links">
      <a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a>
  <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy;
    2011 -
    2019
    <span class="heart">
      <i class="iconfont icon-bulb"></i>
    </span>
    <span class="author">XguoX</span>
  </span>
</div>
          </footer>

          <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.733a52a9.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62252083-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
