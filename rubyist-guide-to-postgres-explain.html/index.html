<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ç»™ Rubyist çš„ Postgresql Explain æ•™ç¨‹ - XguoX - å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="XguoX" /><meta name="description" content="å¦‚æœæƒ³çŸ¥é“ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸ºå•¥å˜å¾—è¶Šæ¥è¶Šæ…¢äº†ï¼Œ é‚£æ²¡æœ‰å•¥æ¯” postgres çš„ EXPLAIN æ›´å¥½ä½¿çš„äº†ã€‚ å…¶å®ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ã€‚ å°±æ˜¯è®© postgres å‘Šè¯‰å’±ä»¬ï¼Œå®ƒæ˜¯æ€ä¹ˆå»æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ã€‚ä½ ç”šè‡³" /><meta name="keywords" content="Ruby, Golang, Erlang, å‰ç«¯, åç«¯, Android, Elasticsearch, Programmer, Photo, Lens, Camera, Sony, A7r, Fujifilm, Lego" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://xguox.me/rubyist-guide-to-postgres-explain.html/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3eafe5cf.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="ç»™ Rubyist çš„ Postgresql Explain æ•™ç¨‹" />
<meta property="og:description" content="å¦‚æœæƒ³çŸ¥é“ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸ºå•¥å˜å¾—è¶Šæ¥è¶Šæ…¢äº†ï¼Œ é‚£æ²¡æœ‰å•¥æ¯” postgres çš„ EXPLAIN æ›´å¥½ä½¿çš„äº†ã€‚ å…¶å®ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ã€‚ å°±æ˜¯è®© postgres å‘Šè¯‰å’±ä»¬ï¼Œå®ƒæ˜¯æ€ä¹ˆå»æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ã€‚ä½ ç”šè‡³" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xguox.me/rubyist-guide-to-postgres-explain.html/" />
<meta property="article:published_time" content="2017-04-27T16:01:23&#43;08:00"/>
<meta property="article:modified_time" content="2017-04-27T16:01:23&#43;08:00"/>

<meta itemprop="name" content="ç»™ Rubyist çš„ Postgresql Explain æ•™ç¨‹">
<meta itemprop="description" content="å¦‚æœæƒ³çŸ¥é“ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸ºå•¥å˜å¾—è¶Šæ¥è¶Šæ…¢äº†ï¼Œ é‚£æ²¡æœ‰å•¥æ¯” postgres çš„ EXPLAIN æ›´å¥½ä½¿çš„äº†ã€‚ å…¶å®ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ã€‚ å°±æ˜¯è®© postgres å‘Šè¯‰å’±ä»¬ï¼Œå®ƒæ˜¯æ€ä¹ˆå»æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ã€‚ä½ ç”šè‡³">


<meta itemprop="datePublished" content="2017-04-27T16:01:23&#43;08:00" />
<meta itemprop="dateModified" content="2017-04-27T16:01:23&#43;08:00" />
<meta itemprop="wordCount" content="2199">



<meta itemprop="keywords" content="Ruby,Postgres,Translation," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ç»™ Rubyist çš„ Postgresql Explain æ•™ç¨‹"/>
<meta name="twitter:description" content="å¦‚æœæƒ³çŸ¥é“ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸ºå•¥å˜å¾—è¶Šæ¥è¶Šæ…¢äº†ï¼Œ é‚£æ²¡æœ‰å•¥æ¯” postgres çš„ EXPLAIN æ›´å¥½ä½¿çš„äº†ã€‚ å…¶å®ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ã€‚ å°±æ˜¯è®© postgres å‘Šè¯‰å’±ä»¬ï¼Œå®ƒæ˜¯æ€ä¹ˆå»æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ã€‚ä½ ç”šè‡³"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div class="row">
    <div class="col s12 m4">
      <div class="table cover">
        <div class="cover-card table-cell table-middle">

  <img src="/img/logo.jpeg" alt="" class="avatar">

  <a href="https://xguox.me/" class="author_name">XguoX</a>
  <span class="author_job">å†™ç‚¹ Ruby ç³Šå£é¥­åƒ</span>
  <span class="author_bio mbm"> ğŸ¨ é•¿è‰å­¦ç”»ç”» ... </span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="https://xguox.me/">home</a>
        <span>/</span>
      </li>

      <li class="nav-item">
        <a href="https://xguox.me/post/">Archive</a>

          <span>/</span>

      </li>

      <li class="nav-item">
        <a href="https://xguox.me/categories/">Categories</a>
      </li>

    </ul>
  </nav>

  <div class="social-links">
    <ul>
        <li><a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a></li>
        <li><a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a></li>
        <li><a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a></li>
    <li>
      <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
    </li>
    </ul>
  </div>

  <section id="js-search" class="p-3 p-lg-5 d-flex flex-column">
    <div class="my-auto" >
      <form action="https://xguox.me/search">
        <input id="search-query" name="s" placeholder="~$ enter to search"/>
      </form>
    </div>
  </section>
</div>
      </div>
    </div>
    <div class="col s12 m8">
      <div class="post-listing">
        
        <div class="container" id="mobile-panel">
          

          <main id="main" class="main">
            <div class="content-wrapper">
              <div id="content" class="content">
                <article class="post inner">
    <a class="home-btn" href= "https://xguox.me/" >
      Home
    </a>
    
    <header class="post-header">
      <h1 class="post-title">ç»™ Rubyist çš„ Postgresql Explain æ•™ç¨‹</h1>

      <div class="post-meta">
        <span class="post-time"> 27 Apr 2017 </span>
          <span class="more-meta"> 2199 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
      <div class="post-category">
          <a href="/categories/ruby/"> Ruby </a>
          <a href="/categories/postgres/"> Postgres </a>
          <a href="/categories/translation/"> Translation </a>
          </div>
    </header>

    
    <div class="post-content">
      

<p>å¦‚æœæƒ³çŸ¥é“ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸ºå•¥å˜å¾—è¶Šæ¥è¶Šæ…¢äº†ï¼Œ é‚£æ²¡æœ‰å•¥æ¯” <strong>postgres</strong> çš„ <code>EXPLAIN</code> æ›´å¥½ä½¿çš„äº†ã€‚</p>

<p>å…¶å®ä¹Ÿæ²¡å•¥ç¥ç§˜çš„ã€‚ å°±æ˜¯è®© postgres å‘Šè¯‰å’±ä»¬ï¼Œå®ƒæ˜¯æ€ä¹ˆå»æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢çš„ã€‚ä½ ç”šè‡³å¯ä»¥è¿›è¡Œå®é™…æŸ¥è¯¢ç„¶åæ¯”è¾ƒå®é™…çš„å’Œé¢„æœŸæ€§èƒ½å·®åˆ«ã€‚</p>

<h3 id="sound-familiar">Sound familiar?</h3>

<p>ä¹Ÿè®¸ä½ å·²ç»è§è¯†è¿‡ <strong>EXPLAIN</strong>. æ—©åœ¨ Rails 3.2 å¼€å§‹ï¼Œ Rails ä¼šè‡ªåŠ¨ **<em>EXPLAIN</em> é‚£äº›è€—æ—¶å¤§äº 500ms çš„æŸ¥è¯¢ã€‚</p>

<p>ä½†é—®é¢˜æ˜¯ï¼Œå…¶è¾“å‡ºçš„ç»“æœæœ‰äº›éšç§˜ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œè¿™æ˜¯ä» rails development blog æ‹¿æ¥çš„:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="sx">% User.where(:id </span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span><span class="o">.</span><span class="n">explain</span>

<span class="no">EXPLAIN</span> <span class="k">for</span><span class="p">:</span> <span class="no">SELECT</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;users&#34;</span> <span class="no">INNER</span> <span class="no">JOIN</span> <span class="s2">&#34;posts&#34;</span> <span class="no">ON</span> <span class="s2">&#34;posts&#34;</span><span class="o">.</span><span class="s2">&#34;user_id&#34;</span> <span class="o">=</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="no">WHERE</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="o">=</span> <span class="mi">1</span>
                                  <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">------------------------------------------------------------------------------</span>
 <span class="no">Nested</span> <span class="no">Loop</span> <span class="no">Left</span> <span class="no">Join</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">37</span><span class="o">.</span><span class="mi">24</span> <span class="n">rows</span><span class="o">=</span><span class="mi">8</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
   <span class="no">Join</span> <span class="ss">Filter</span><span class="p">:</span> <span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Index</span> <span class="no">Scan</span> <span class="n">using</span> <span class="n">users_pkey</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">8</span><span class="o">.</span><span class="mi">27</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
         <span class="no">Index</span> <span class="ss">Cond</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">posts</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">28</span><span class="o">.</span><span class="mi">88</span> <span class="n">rows</span><span class="o">=</span><span class="mi">8</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
         <span class="ss">Filter</span><span class="p">:</span> <span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">6</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>æ‰€ä»¥ï¼Œ è¿™æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†ä¼šåˆ†æç±»ä¼¼è¿™æ ·çš„è¾“å‡ºç»“æœï¼ŒåŠå…¶ç»™æˆ‘ä»¬çš„ Ruby Web å¼€å‘æ‰€å¸¦æ¥çš„å½±å“ã€‚</p>

<h3 id="the-syntax">The syntax</h3>

<p>å¦‚æœæ­£åœ¨ä½¿ç”¨çš„æ˜¯ Rails, é‚£ä¹ˆå¯ä»¥åœ¨ä»»æ„ ActiveRecord æŸ¥è¯¢åé¢åŠ ä¸Š <code>.explain</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">explain</span>
  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;users&#34;</span> <span class="no">WHERE</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="o">=</span> <span class="vg">$1</span>  <span class="o">[[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]]</span>
<span class="o">=&gt;</span> <span class="no">EXPLAIN</span> <span class="k">for</span><span class="p">:</span> <span class="no">SELECT</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;users&#34;</span> <span class="no">WHERE</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="o">=</span> <span class="vg">$1</span> <span class="o">[[</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]]</span>
                                <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">--------------------------------------------------------------------------</span>
 <span class="no">Index</span> <span class="no">Scan</span> <span class="n">using</span> <span class="n">users_pkey</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">29</span><span class="o">..</span><span class="mi">8</span><span class="o">.</span><span class="mi">30</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span>
   <span class="no">Index</span> <span class="ss">Cond</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>è™½ç„¶ï¼Œ<code>EXPLAIN</code> æ–¹æ³•ä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œ ä½†æ˜¯ï¼Œ å®ƒå¹¶æ²¡æœ‰ç»™ä½ ä¸€äº›æˆ‘ä»¬å¯ä»¥åœ¨ postgres ä¸­å¯ä»¥ç”¨åˆ°çš„é«˜çº§é€‰é¡¹ã€‚</p>

<p>è¦åœ¨ postgres ä¸­ç›´æ¥ä½¿ç”¨ <strong>EXPLAIN</strong>ï¼Œ é¦–å…ˆç”¨ <code>psql -d yourdb</code> è¿›å…¥åˆ°ä½ çš„æ•°æ®åº“ä¸­ï¼Œç„¶åå†æ‰§è¡Œä¸‹é¢è¿™æ¡è¯­å¥:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">EXPLAIN</span> <span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="n">users</span> <span class="no">WHERE</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                                <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">--------------------------------------------------------------------------</span>
 <span class="no">Index</span> <span class="no">Scan</span> <span class="n">using</span> <span class="n">users_pkey</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">29</span><span class="o">..</span><span class="mi">8</span><span class="o">.</span><span class="mi">30</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span>
   <span class="no">Index</span> <span class="ss">Cond</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€äº›å…³äº postgres å¦‚ä½•æ‰§è¡ŒæŸ¥è¯¢çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœ€å°‘éœ€è¦åšå¤šå°‘å·¥ä½œæ¥å®Œæˆè¿™ä¸ªæŸ¥è¯¢ã€‚</p>

<p>åªç”¨ <strong>EXPLAIN</strong> çš„è¯å¹¶ä¸ä¼šçœŸæ­£çš„æ‰§è¡Œè¿™æ¡è¯­å¥ï¼Œæƒ³è¦çœŸæ­£æ‰§è¡Œè¯­å¥ï¼Œ å¹¶ç»™å‡ºé¢„æœŸä¸å®é™…è¿è¡Œç»“æœçš„å¯¹æ¯”åˆ™éœ€è¦ç”¨ <code>EXPLAIN ANALYZE</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">EXPLAIN</span> <span class="no">ANALYZE</span> <span class="no">SELECT</span> <span class="o">*</span> <span class="no">FROM</span> <span class="n">users</span> <span class="no">WHERE</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                               <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">------------------------------------------------------------------------------------</span>
 <span class="no">Index</span> <span class="no">Scan</span> <span class="n">using</span> <span class="n">users_pkey</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">29</span><span class="o">..</span><span class="mi">8</span><span class="o">.</span><span class="mi">30</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">043</span><span class="o">..</span><span class="mi">0</span><span class="o">.</span><span class="mo">044</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="no">Index</span> <span class="ss">Cond</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
 <span class="no">Total</span> <span class="ss">runtime</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">117</span> <span class="n">ms</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="interpreting-the-output">Interpreting the output</h3>

<p>Postgres å¾ˆèªæ˜çš„å‘¢ï¼Œä»–å¯ä»¥æ‰¾åˆ°æœ€é«˜æ•ˆçš„æ–¹å¼æ¥æ‰§è¡Œä½ çš„æŸ¥è¯¢ã€‚æ¢å¥è¯è¯´ï¼Œä»–ä¼šç”Ÿæˆä¸€ä¸ªã€ŒæŸ¥è¯¢è®¡åˆ’ã€ï¼Œç„¶å <code>explain</code>åªæ˜¯è´Ÿè´£æŠŠè¿™ä¸ªè®¡åˆ’è¾“å‡ºå‡ºæ¥ã€‚</p>

<p>è€ƒè™‘ä»¥ä¸‹æƒ…å†µ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># explain select * from users order by created_at limit 10;</span>
                               <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">-------------------------------------------------------------------------</span>
 <span class="no">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">892</span><span class="o">.</span><span class="mi">98</span><span class="o">..</span><span class="mi">893</span><span class="o">.</span><span class="mo">01</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">892</span><span class="o">.</span><span class="mi">98</span><span class="o">..</span><span class="mi">919</span><span class="o">.</span><span class="mi">16</span> <span class="n">rows</span><span class="o">=</span><span class="mi">104</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span>
         <span class="no">Sort</span> <span class="ss">Key</span><span class="p">:</span> <span class="n">created_at</span>
         <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">666</span><span class="o">.</span><span class="mi">71</span> <span class="n">rows</span><span class="o">=</span><span class="mi">104</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™ä¸ªè¾“å‡ºç”±ä¸¤éƒ¨åˆ†ç»„æˆ:</p>

<ol>
<li>ã€ŒèŠ‚ç‚¹åˆ—è¡¨ã€(node list) æè¿°äº†æ‰§è¡Œè¯¥æŸ¥è¯¢æ—¶å€™æ‰€å‘ç”Ÿçš„ä¸€ç³»åˆ—åŠ¨ä½œ</li>
<li>æ€§èƒ½é¢„ä¼°ï¼Œæè¿°äº†è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ¯ä¸ªåŠ¨ä½œçš„è€—æ—¶ã€‚</li>
</ol>

<h3 id="the-node-list">The node list</h3>

<p>å»æ‰æ‰€æœ‰çš„æ€§èƒ½è¯„ä¼°ä»¥åï¼Œ ä¹Ÿå°±åªå‰©ä¸‹èŠ‚ç‚¹åˆ—è¡¨äº†ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Limit</span>
   <span class="o">-&gt;</span>  <span class="no">Sort</span> <span class="p">(</span><span class="no">Sort</span> <span class="ss">Key</span><span class="p">:</span> <span class="n">created_at</span><span class="p">)</span>
         <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">users</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™æœ‰ç‚¹åƒæ˜¯ä¸€ä¸ª Postgres å†™çš„ã€Œç¨‹åºã€ç”¨æ¥æ‰§è¡ŒæŸ¥è¯¢æ“ä½œã€‚ å…¶ä¸­åŒ…å«äº†ä¸‰ä¸ªåŠ¨ä½œï¼Œ &ldquo;limit&rdquo;, &ldquo;sort&rdquo; å’Œ &ldquo;seq scan&rdquo;ã€‚ å­èŠ‚ç‚¹ä¸­çš„è¾“å‡ºç»“æœä¼šè¢«å‘ä¸Šä¼ é€åˆ°çˆ¶èŠ‚ç‚¹ã€‚ ç”¨ Ruby çš„è¯æ¥è¯´å°±æ˜¯:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">all_users</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Postgres ä¼šåœ¨æŸ¥è¯¢è®¡åˆ’ä¸­ä½¿ç”¨è®¸å¤šä¸åŒçš„åŠ¨ä½œã€‚ ä½†ä½ å¹¶ä¸éœ€è¦æŒæ¡æ‰€æœ‰çš„è¿™äº›åŠ¨ä½œçš„å«ä¹‰ï¼Œè®°ä½ä¸‹é¢è¿™å‡ ä¸ªå°±å¥½äº†:</p>

<ul>
<li>Index Scan: é€šè¿‡ç´¢å¼•æ¥è·å–è®°å½•ã€‚ ç±»ä¼¼åœ¨ Ruby çš„ Hash ä¸­æŸ¥æ‰¾æŸä¸€é¡¹ã€‚</li>
<li>Seq Scan: é€šè¿‡éå†ç»“æœé›†æ¥è·å–è®°å½•ã€‚</li>
<li>Filter: ä»ç»“æœé›†ä¸­é€‰æ‹©é‚£äº›åŒ¹é…æŸæ¡ä»¶çš„è®°å½•ã€‚</li>
<li>Sort: å¯¹ç»“æœé›†æ’åº</li>
<li>Aggregate: å½“æ‰§è¡Œåƒ count, max, min è¿™ç±»æ“ä½œæ—¶å€™ä¼šç”¨åˆ°</li>
<li>Bitmap Heap Scan: Uses a bitmap to represent matching records. Operations like and-ing and or-ing can sometimes be done more easily to the bitmap than to the actual records.</li>
</ul>

<p><a href="https://github.com/digoal/blog/blob/master/201702/20170221_02.md">https://github.com/digoal/blog/blob/master/201702/20170221_02.md</a></p>

<h3 id="performance-estimates">Performance estimates</h3>

<p>èŠ‚ç‚¹åˆ—è¡¨ä¸­ï¼Œ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ç»„æ€§èƒ½è¯„ä¼°ã€‚ä¸€èˆ¬é•¿è¿™æ ·å­çš„:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">892</span><span class="o">.</span><span class="mi">98</span><span class="o">..</span><span class="mi">893</span><span class="o">.</span><span class="mo">01</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿™äº›æ•°å­—ä»£è¡¨æ„æ€:</p>

<ul>
<li><strong>Cost</strong>: è¯¥åŠ¨ä½œçš„æ‰§è¡Œæˆæœ¬ã€‚å®ƒæ²¡æœ‰å…·ä½“çš„å•ä½ï¼Œ åªèƒ½å’Œå…¶ä»–åŒæ ·æ˜¯ <strong>Cost</strong> çš„æ•°å­—è¿›è¡Œå¯¹æ¯”</li>
<li><strong>Rows</strong>: æ‰§è¡Œè¯¥æ“ä½œä¸€å…±éœ€è¦éå†å¤šå°‘è¡Œè®°å½•ã€‚</li>
<li><strong>Width</strong>: æ¯ä¸€è¡Œå¤§æ¦‚æœ‰å¤šå°‘å­—èŠ‚ã€‚</li>
</ul>

<p>æœ€å¸¸ç”¨åˆ°çš„å‚æ•°åº”è¯¥æ˜¯ <strong>Rows</strong>ã€‚å®ƒå¯ä»¥æ¸…æ¥šçš„è®©æˆ‘ä»¬çŸ¥é“æŸ¥è¯¢çš„æ€§èƒ½ã€‚ å¦‚æœè¿™ä¸ªå€¼ç­‰äº 1ï¼Œ é‚£ä¹ˆè¯¥æŸ¥è¯¢æ€§èƒ½æ æ çš„ã€‚ å¦‚æœå‘ç°è¿™ä¸ªå€¼ç­‰äºè¡¨ä¸­è®°å½•çš„æ€»æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢æ€§èƒ½å°±ä¼šéšç€è¡¨çš„å¢å¤§å˜çš„è¶Šæ¥è¶Šæ…¢äº†ã€‚</p>

<h3 id="actual-performance-values">Actual performance values</h3>

<p>ä½¿ç”¨ <strong>EXPLAIN ANALYZE</strong> æ—¶ï¼Œ ä¼šçœŸæ­£çš„å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œç„¶åå°±ä¼šå‡ºç°ä¸¤ç»„æ•°å­—ã€‚å‰ä¸€ç»„æ˜¯åƒä¸Šé¢çš„é¢„ä¼°å€¼ï¼Œåä¸€ç»„åˆ™æ˜¯å®é™…å€¼ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># explain analyze select * from users order by created_at limit 10;</span>
                                                       <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">------------------------------------------------------------------------------------------------------------------------</span>
 <span class="no">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">892</span><span class="o">.</span><span class="mi">98</span><span class="o">..</span><span class="mi">893</span><span class="o">.</span><span class="mo">01</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">22</span><span class="o">.</span><span class="mi">443</span><span class="o">..</span><span class="mi">22</span><span class="o">.</span><span class="mi">446</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">892</span><span class="o">.</span><span class="mi">98</span><span class="o">..</span><span class="mi">919</span><span class="o">.</span><span class="mi">16</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10471</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">22</span><span class="o">.</span><span class="mi">441</span><span class="o">..</span><span class="mi">22</span><span class="o">.</span><span class="mi">443</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="no">Sort</span> <span class="ss">Key</span><span class="p">:</span> <span class="n">created_at</span>
         <span class="no">Sort</span> <span class="ss">Method</span><span class="p">:</span> <span class="n">top</span><span class="o">-</span><span class="n">N</span> <span class="n">heapsort</span>  <span class="ss">Memory</span><span class="p">:</span> <span class="mi">31</span><span class="n">kB</span>
         <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">users</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">666</span><span class="o">.</span><span class="mi">71</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10471</span> <span class="n">width</span><span class="o">=</span><span class="mi">812</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">203</span><span class="o">..</span><span class="mi">15</span><span class="o">.</span><span class="mi">221</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10472</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
 <span class="no">Total</span> <span class="ss">runtime</span><span class="p">:</span> <span class="mi">22</span><span class="o">.</span><span class="mi">519</span> <span class="n">ms</span>
<span class="p">(</span><span class="mi">6</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Actual time: æ‰§è¡Œè¯¥åŠ¨ä½œè€—è´¹çš„æ—¶é•¿(ms)</li>
<li>Rows: æ‰§è¡Œè¯¥æ“ä½œå®é™…éå†äº†å¤šå°‘è¡Œè®°å½•ã€‚</li>
<li>Loops: æœ‰æ—¶å€™æŸä¸ªåŠ¨ä½œä¼šå‘ç”Ÿä¸æ­¢ä¸€æ¬¡ï¼Œ æ­¤æ—¶ï¼Œ loops ä¼šå¤§äº 1</li>
</ul>

<h3 id="more-verbose-output">More verbose output</h3>

<p>é»˜è®¤æƒ…å†µä¸‹ <strong>EXPLAIN</strong> ç»™çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒç²¾ç®€çš„ç‰ˆæœ¬ã€‚å…¶å®ï¼Œ ä½ å¯ä»¥è®©ä»ä»–é‚£å¾—åˆ°æ›´å¤šæ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚ç”šè‡³å¯ä»¥è®©ä»–çš„è¾“å‡ºä¿¡æ¯æ ¼å¼åŒ–ä¸º JSON æˆ–è€… YAML.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># EXPLAIN (ANALYZE, FORMAT YAML) select * from users order by created_at limit 10;</span><span class="w">
</span><span class="w">                </span>QUERY<span class="w"> </span>PLAN<span class="w">
</span><span class="w"></span>-----------------------------------------<span class="sd">-
</span><span class="sd"> - Plan:                                 +</span><span class="w">
</span><span class="w">     </span>Node<span class="w"> </span>Type<span class="p">:</span><span class="w"> </span><span class="s2">&#34;Limit&#34;</span><span class="w">                  </span><span class="sd">+
</span><span class="sd">     Startup Cost: 892.98                +</span><span class="w">
</span><span class="w">     </span>Total<span class="w"> </span>Cost<span class="p">:</span><span class="w"> </span><span class="m">893.01</span><span class="w">                  </span><span class="sd">+
</span><span class="sd">     Plan Rows: 10                       +</span><span class="w">
</span><span class="w">     </span>Plan<span class="w"> </span>Width<span class="p">:</span><span class="w"> </span><span class="m">812</span><span class="w">                     </span><span class="sd">+
</span><span class="sd">     Actual Startup Time: 12.945         +</span><span class="w">
</span><span class="w">     </span>Actual<span class="w"> </span>Total<span class="w"> </span>Time<span class="p">:</span><span class="w"> </span><span class="m">12.947</span><span class="w">           </span><span class="sd">+
</span><span class="sd">     Actual Rows: 10                     +</span><span class="w">
</span><span class="w">     </span>Actual<span class="w"> </span>Loops<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">                     </span><span class="sd">+
</span><span class="sd">     Plans:                              +</span><span class="w">
</span><span class="w">       </span>-<span class="w"> </span>Node<span class="w"> </span>Type<span class="p">:</span><span class="w"> </span><span class="s2">&#34;Sort&#34;</span><span class="w">               </span><span class="sd">+
</span><span class="sd">         Parent Relationship: &#34;Outer&#34;    +</span><span class="w">
</span><span class="w">         </span>Startup<span class="w"> </span>Cost<span class="p">:</span><span class="w"> </span><span class="m">892.98</span><span class="w">            </span><span class="sd">+
</span><span class="sd">         Total Cost: 919.16              +</span><span class="w">
</span><span class="w">         </span>Plan<span class="w"> </span>Rows<span class="p">:</span><span class="w"> </span><span class="m">10471</span><span class="w">                </span><span class="sd">+
</span><span class="sd">         Plan Width: 812                 +</span><span class="w">
</span><span class="w">         </span>Actual<span class="w"> </span>Startup<span class="w"> </span>Time<span class="p">:</span><span class="w"> </span><span class="m">12.944</span><span class="w">     </span><span class="sd">+
</span><span class="sd">         Actual Total Time: 12.946       +</span><span class="w">
</span><span class="w">         </span>Actual<span class="w"> </span>Rows<span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">                 </span><span class="sd">+
</span><span class="sd">         Actual Loops: 1                 +</span><span class="w">
</span><span class="w">         </span>Sort<span class="w"> </span>Key<span class="p">:</span><span class="w">                       </span><span class="sd">+
</span><span class="sd">           - &#34;created_at&#34;                +</span><span class="w">
</span><span class="w">         </span>Sort<span class="w"> </span>Method<span class="p">:</span><span class="w"> </span><span class="s2">&#34;top-N heapsort&#34;</span><span class="w">   </span><span class="sd">+
</span><span class="sd">         Sort Space Used: 31             +</span><span class="w">
</span><span class="w">         </span>Sort<span class="w"> </span>Space<span class="w"> </span>Type<span class="p">:</span><span class="w"> </span><span class="s2">&#34;Memory&#34;</span><span class="w">       </span><span class="sd">+
</span><span class="sd">         Plans:                          +</span><span class="w">
</span><span class="w">           </span>-<span class="w"> </span>Node<span class="w"> </span>Type<span class="p">:</span><span class="w"> </span><span class="s2">&#34;Seq Scan&#34;</span><span class="w">       </span><span class="sd">+
</span><span class="sd">             Parent Relationship: &#34;Outer&#34;+</span><span class="w">
</span><span class="w">             </span>Relation<span class="w"> </span>Name<span class="p">:</span><span class="w"> </span><span class="s2">&#34;users&#34;</span><span class="w">      </span><span class="sd">+
</span><span class="sd">             Alias: &#34;users&#34;              +</span><span class="w">
</span><span class="w">             </span>Startup<span class="w"> </span>Cost<span class="p">:</span><span class="w"> </span><span class="m">0.00</span><span class="w">          </span><span class="sd">+
</span><span class="sd">             Total Cost: 666.71          +</span><span class="w">
</span><span class="w">             </span>Plan<span class="w"> </span>Rows<span class="p">:</span><span class="w"> </span><span class="m">10471</span><span class="w">            </span><span class="sd">+
</span><span class="sd">             Plan Width: 812             +</span><span class="w">
</span><span class="w">             </span>Actual<span class="w"> </span>Startup<span class="w"> </span>Time<span class="p">:</span><span class="w"> </span><span class="m">0.008</span><span class="w">  </span><span class="sd">+
</span><span class="sd">             Actual Total Time: 5.823    +</span><span class="w">
</span><span class="w">             </span>Actual<span class="w"> </span>Rows<span class="p">:</span><span class="w"> </span><span class="m">10472</span><span class="w">          </span><span class="sd">+
</span><span class="sd">             Actual Loops: 1             +</span><span class="w">
</span><span class="w">   </span>Triggers<span class="p">:</span><span class="w">                             </span><span class="sd">+
</span><span class="sd">   Total Runtime: 13.001</span><span class="w">
</span><span class="w"></span>(<span class="m">1</span><span class="w"> </span>row)</code></pre></td></tr></table>
</div>
</div>
<p>è¿˜å¯ä»¥è¿™æ ·ï¼Œ<code>EXPLAIN (ANALYZE, VERBOSE, FORMAT YAML) SELECT ...</code></p>

<h3 id="visualization-tools">Visualization tools</h3>

<p>Explain ä¼šç”Ÿæˆä¸€å¤§å †çš„è¾“å‡ºã€‚ å°¤å…¶å½“æŸ¥è¯¢æ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œæ›´æ˜¯éš¾ä»¥è§£æã€‚</p>

<p>æœ‰ä¸€äº›å…è´¹çš„å·¥å…·å¯ä»¥å¸®ä¸Šå¿™ã€‚ä»–ä»¬ä¼šå¸®åŠ©è§£æå¹¶ç”Ÿæˆä¸€äº›æ¼‚äº®çš„å›¾è¡¨ç»™ä½ ã€‚ç”šè‡³ä¼šç»™å‡ºä¸€äº›æ ‡è®°æŒ‡å‡ºæ½œåœ¨çš„æ€§èƒ½é—®é¢˜ã€‚<a href="http://tatiyants.com/pev/#/plans/new">æ¯”å¦‚è¿™ä¸ª</a></p>

<p><img src="http://www.rubyletter.com/images/2016/12/explain.png" alt="" /></p>

<h3 id="examples">Examples</h3>

<p>æŠŠä¸Šé¢æåˆ°çš„æ±‡æ€»ä¸€èµ·ä¸¾ä¸ªä¾‹å­ã€‚ä½ æ˜¯å¦å‘ç°æŸä¸€äº› Rails çš„é€šç”¨åšæ³•ä¼šç”Ÿæˆä¸€äº›æ€§èƒ½ä¸ä½³çš„æ•°æ®åº“æŸ¥è¯¢?</p>

<h4 id="the-counting-conundrum">The counting conundrum</h4>

<p>ä¸‹é¢çš„ç”¨æ³•åº”è¯¥æ˜¯éå¸¸å¸¸è§çš„å§:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Total</span> <span class="no">Faults</span> <span class="o">&lt;%=</span> <span class="no">Fault</span><span class="o">.</span><span class="n">count</span> <span class="o">%&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>å¯¹åº”ç”Ÿæˆçš„ SQL è¯­å¥å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">select</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">from</span> <span class="n">faults</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>ç»™ <strong>EXPLAIN</strong> ä¸€ä¸‹ï¼Œçœ‹çœ‹å‘ç”Ÿäº†äº›ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># explain select count(*) from faults;</span>
                            <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">-------------------------------------------------------------------</span>
 <span class="no">Aggregate</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">1840</span><span class="o">.</span><span class="mi">31</span><span class="o">..</span><span class="mi">1840</span><span class="o">.</span><span class="mi">32</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">faults</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">1784</span><span class="o">.</span><span class="mi">65</span> <span class="n">rows</span><span class="o">=</span><span class="mi">22265</span> <span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Woah! ç®€å•çš„ä¸€ä¸ª count æŸ¥è¯¢ï¼Œç«Ÿç„¶éå†äº†  22,265 è¡Œï¼Œ ä¹Ÿå°±æ˜¯æ•´ä¸ªè¡¨ã€‚ åœ¨ Postgres , count éƒ½æ˜¯å…¨è¡¨æŸ¥çš„ã€‚</p>

<h4 id="the-sorting-scandal">The sorting scandal</h4>

<p>ä¸‹é¢è¿™ä¸ªä¹Ÿå¸¸è§å§ï¼Œ æ ¹æ®æŸä¸ªå­—æ®µè¿›è¡Œæ’åºã€‚ æ¯”å¦‚:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="no">Fault</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s2">&#34;created_at desc&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>å…¶å®ä½ åªæƒ³è¦ 10 æ¡è®°å½•è€Œå·²ã€‚ ä½†ï¼Œ ä¸ºäº†å¾—åˆ°è¿™ 10 æ¡è®°å½•ï¼Œ ä½ éœ€è¦å¯¹æ•´ä¸ªè¡¨è¿›è¡Œæ’åºã€‚ ä»ä¸‹é¢å¯ä»¥çœ‹å‡º <strong>Sort</strong> æ“ä½œéå†äº† 22,265 è¡Œè®°å½•.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># explain select * from faults order by created_at limit 10;</span>
                                 <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">----------------------------------------------------------------------------</span>
 <span class="no">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">2265</span><span class="o">.</span><span class="mi">79</span><span class="o">..</span><span class="mi">2265</span><span class="o">.</span><span class="mi">81</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">1855</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Sort</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">2265</span><span class="o">.</span><span class="mi">79</span><span class="o">..</span><span class="mi">2321</span><span class="o">.</span><span class="mi">45</span> <span class="n">rows</span><span class="o">=</span><span class="mi">22265</span> <span class="n">width</span><span class="o">=</span><span class="mi">1855</span><span class="p">)</span>
         <span class="no">Sort</span> <span class="ss">Key</span><span class="p">:</span> <span class="n">created_at</span>
         <span class="o">-&gt;</span>  <span class="no">Seq</span> <span class="no">Scan</span> <span class="n">on</span> <span class="n">faults</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="o">..</span><span class="mi">1784</span><span class="o">.</span><span class="mi">65</span> <span class="n">rows</span><span class="o">=</span><span class="mi">22265</span> <span class="n">width</span><span class="o">=</span><span class="mi">1855</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>é€šè¿‡æ·»åŠ ç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠ **<em>Sort</em> è¿™ä¸ªæ“ä½œæ¢æˆæ›´é«˜æ•ˆçš„ <strong>Index Scan</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># CREATE INDEX index_faults_on_created_at ON faults USING btree (created_at);</span>
<span class="no">CREATE</span> <span class="no">INDEX</span>

<span class="c1"># explain select * from faults order by created_at limit 10;</span>
                                               <span class="no">QUERY</span> <span class="no">PLAN</span>
<span class="o">---------------------------------------------------------------------------------------------------------</span>
 <span class="no">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">29</span><span class="o">..</span><span class="mi">2</span><span class="o">.</span><span class="mi">66</span> <span class="n">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">1855</span><span class="p">)</span>
   <span class="o">-&gt;</span>  <span class="no">Index</span> <span class="no">Scan</span> <span class="n">using</span> <span class="n">index_faults_on_created_at</span> <span class="n">on</span> <span class="n">faults</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">29</span><span class="o">..</span><span class="mi">5288</span><span class="o">.</span><span class="mo">04</span> <span class="n">rows</span><span class="o">=</span><span class="mi">22265</span> <span class="n">width</span><span class="o">=</span><span class="mi">1855</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span> <span class="n">rows</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="conclusion">Conclusion</h3>

<p>å¼ºçƒˆå»ºè®®å¤šä¸€äº›ä½¿ç”¨ <code>EXPLAIN</code> è¿™ä¸ªå‘½ä»¤ï¼Œ è¿™æ ·ï¼Œ å½“æ•°æ®è¶Šæ¥è¶Šå¤§ï¼Œæ—¶å€™ä¸è‡³äºæªæ‰‹æ— ç­–ã€‚</p>

<p>è¯‘è‡ª: <a href="http://www.rubyletter.com/blog/2017/03/13/rubyist-guide-to-postgres-explain.html">A Rubyist&rsquo;s Guide to Postgresql&rsquo;s Explain</a></p>

    </div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ruby/">Ruby</a>
          <a href="/tags/postgres/">Postgres</a>
          <a href="/tags/translation/">Translation</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/last-two-months.html/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">åœæ›´çš„ä¸¤ä¸ªæœˆ</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/nginx-underscore_in_header.html/">
            <span class="next-text nav-default">Nginx é»˜è®¤ä¸å…è®¸ header çš„ key å¸¦ä¸‹åˆ’çº¿</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
              </div>
              <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xguox';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

            </div>
          </main>

          <footer id="footer" class="footer">
            <div class="social-links">
      <a href="mailto:xguox@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/XguoX_L" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/xguox" class="iconfont icon-github" title="github"></a>
  <a href="https://xguox.me/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme -
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy;
    2011 -
    2019
    <span class="heart">
      <i class="iconfont icon-bulb"></i>
    </span>
    <span class="author">XguoX</span>
  </span>
</div>
          </footer>

          <div class="back-to-top" id="back-to-top">
            <i class="iconfont icon-up"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.733a52a9.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62252083-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
